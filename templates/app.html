<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Trading Cabinet</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --tg-bg: #12171d;
            --tg-text: #ffffff;
            --tg-hint: #8c96a3;
            --tg-button: #0088cc;
            --tg-button-text: #ffffff;
            --glass-bg: rgba(27, 39, 53, 0.6);
            --glass-border: rgba(255, 255, 255, 0.1);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes pulse {
            0% { transform: scale(1); opacity: 0.7; }
            50% { transform: scale(1.05); opacity: 1; }
            100% { transform: scale(1); opacity: 0.7; }
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            margin: 0; color: var(--tg-text); background-color: var(--tg-bg);
            min-height: 100vh; box-sizing: border-box; 
            opacity: 0; transition: opacity 0.5s ease; overflow: hidden;
            display: flex; align-items: center; justify-content: center;
        }
        body.ready { opacity: 1; }

        .view { display: none; width: 100%; height: 100%; }
        .view.active { display: block; }
        
        .centered-content {
            display: flex; flex-direction: column; justify-content: center;
            align-items: center; text-align: center; height: 100%;
            padding: 20px; box-sizing: border-box;
            animation: fadeIn 0.5s ease-out;
        }
        .content-block { max-width: 350px; }
        
        h1 { font-size: 28px; font-weight: 700; margin: 0; line-height: 1.2; }
        h1 span { color: var(--tg-button); }
        p { color: var(--tg-hint); font-size: 16px; line-height: 1.6; margin: 15px 0 30px; }
        .primary-btn {
            background: var(--tg-button); border: none; color: var(--tg-button-text);
            border-radius: 12px; padding: 14px 25px; font-size: 16px;
            font-weight: 600; cursor: pointer; display: inline-flex;
            align-items: center; gap: 8px;
        }
        
        #onboarding-flow {
            display: flex;
            width: 400%;
            height: 100%;
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .onboarding-slide {
            flex: 0 0 100%;
            height: 100%;\
            display: flex;
            justify-content: center;
            align-items: center;
        }
        #onboarding-flow.active { position: fixed; top: 0; left: 0; right: 0; bottom: 0; display: flex; transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        .onboarding-slide { flex: 0 0 100%; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; box-sizing: border-box; padding: 20px; }
        .slide-content { animation: fadeIn 0.6s ease-out; max-width: 350px; }
        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 40px; }
        .stat-item { background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: 12px; padding: 15px 5px; }
        .stat-item .value { font-size: 20px; font-weight: 700; }
        .stat-item .label { font-size: 12px; color: var(--tg-hint); margin-top: 5px; }
        .benefits-list { list-style: none; padding: 0; margin: 20px 0 30px; text-align: left; }
        .benefit-item { display: flex; align-items: center; margin-bottom: 15px; font-size: 16px; }
        .benefit-item svg { width: 22px; height: 22px; color: #28a745; margin-right: 12px; flex-shrink: 0; }
        .nav-buttons { display: flex; justify-content: space-between; align-items: center; width: 100%; }
        .nav-btn { background: var(--glass-bg); border: 1px solid var(--glass-border); color: var(--tg-text); border-radius: 50%; width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .nav-btn.hidden { visibility: hidden; }
        
        .spinner-icon { animation: pulse 1.5s infinite; }
        .back-btn-simple { margin-top: 40px; }
        
        #error-view, #loader-view { text-align: center; }
        #error-view p { color: var(--tg-hint); line-height: 1.6; font-size: 16px; }
    </style>
</head>
<body>
    <div id="loader-view" class="view active">
        <!-- Loader is active by default -->
    </div>

    <!-- === ЭКРАНЫ ДЛЯ НОВЫХ ПОЛЬЗОВАТЕЛЕЙ (ОНБОРДИНГ) === -->
    <div id="onboarding-flow" class="view">
        <!-- Slide 1 -->
        <div class="onboarding-slide">
             <div class="slide-content">
                <h1 data-translate-key="slide1_title"></h1><p data-translate-key="slide1_subtitle"></p>
                <div class="stats-grid">
                    <div class="stat-item"><div class="value">1000+</div><div class="label" data-translate-key="stat_traders"></div></div>
                    <div class="stat-item"><div class="value">95%</div><div class="label" data-translate-key="stat_accuracy"></div></div>
                    <div class="stat-item"><div class="value">24/7</div><div class="label" data-translate-key="stat_support"></div></div>
                </div>
                <div class="nav-buttons">
                    <button class="nav-btn back-btn hidden"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"></polyline></svg></button>
                    <button class="primary-btn next-btn"><span data-translate-key="btn_start"></span></button>
                </div>
            </div>
        </div>
        <!-- Slide 2 -->
        <div class="onboarding-slide">
            <div class="slide-content">
                <h1 data-translate-key="slide2_title"></h1><p data-translate-key="slide2_subtitle"></p>
                <ul class="benefits-list">
                    <li class="benefit-item" data-translate-key="benefit_vip_signals"></li>
                    <li class="benefit-item" data-translate-key="benefit_vip_accuracy"></li>
                </ul>
                <div class="nav-buttons">
                    <button class="nav-btn back-btn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"></polyline></svg></button>
                    <button class="primary-btn next-btn"><span data-translate-key="btn_next"></span></button>
                </div>
            </div>
        </div>
        <!-- Slide 3 -->
        <div class="onboarding-slide">
            <div class="slide-content">
                <h1 data-translate-key="slide3_title"></h1><p data-translate-key="slide3_subtitle"></p>
                <div class="stats-grid" style="grid-template-columns: 1fr 1fr;">
                    <div class="stat-item"><div class="label" data-translate-key="stat_profit"></div><div class="value" data-translate-key="slide3_profit"></div></div>
                    <div class="stat-item"><div class="label" data-translate-key="stat_speed"></div><div class="value" data-translate-key="slide3_speed"></div></div>
                </div>
                <div class="nav-buttons">
                    <button class="nav-btn back-btn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"></polyline></svg></button>
                    <button class="primary-btn next-btn"><span data-translate-key="btn_start_trading"></span></button>
                </div>
            </div>
        </div>
        <!-- Slide 4 -->
        <div class="onboarding-slide">
            <div class="slide-content">
                <h1 data-translate-key="slide4_title"></h1><p data-translate-key="slide4_subtitle"></p>
                 <ul class="benefits-list">
                    <li class="benefit-item"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"></polyline></svg><span data-translate-key="benefit1"></span></li>
                    <li class="benefit-item"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"></polyline></svg><span data-translate-key="benefit2"></span></li>
                    <li class="benefit-item"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"></polyline></svg><span data-translate-key="benefit3"></span></li>
                </ul>
                <div class="nav-buttons">
                    <button class="nav-btn back-btn"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"></polyline></svg></button>
                    <button id="register-btn" class="primary-btn"><span data-translate-key="btn_register"></span></button>
                </div>
            </div>
        </div>
    </div>

    <!-- === ЭКРАНЫ ПОСЛЕ РЕГИСТРАЦИИ === -->
    <div id="post-reg-welcome-view" class="view centered-content">
        <div class="content-block">
            <h1 data-translate-key="post_reg_title"></h1>
            <p data-translate-key="post_reg_subtitle"></p>
            <button id="deposit-btn" class="primary-btn" data-translate-key="post_reg_button"></button>
        </div>
    </div>

    <div id="post-deposit-view" class="view centered-content">
        <div class="content-block">
            <h1 data-translate-key="post_dep_title"></h1>
            <p><span data-translate-key="post_dep_subtitle_p1"></span><b><span id="deposit-amount"></span></b></p>
            <p><span data-translate-key="post_dep_subtitle_p2"></span><b><span id="potential-profit"></span></b></p>
            <p data-translate-key="post_dep_subtitle_p3"></p>
            <button id="go-to-signals-btn" class="primary-btn" data-translate-key="btn_get_vip_signal"></button>
        </div>
    </div>
    
    <div id="vip-signal-search-view" class="view centered-content">
         <div class="content-block">
            <h1 class="spinner-icon">⏳</h1>
            <h1 data-translate-key="searching_title_vip"></h1>
            <p data-translate-key="searching_subtitle_vip"></p>
        </div>
    </div>
    
    <!-- === ЭКРАН ОШИБКИ === -->
    <div id="error-view" class="view">
        <p data-translate-key="error_text"></p>
    </div>

<script>
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();
    tg.setHeaderColor('#12171d');
    tg.setBackgroundColor('#12171d');

    const TRANSLATIONS = {
        'ru': {
            'error_text': 'Ошибка: не удалось определить пользователя.<br>Пожалуйста, откройте приложение через кнопку "Меню" в боте.',
            'slide1_title': '<span>Premium</span> сигналы для Pocket Option', 'slide1_subtitle': 'Получайте точные торговые сигналы от профессиональных аналитиков с точностью до 95%.',
            'stat_traders': 'Трейдеры', 'stat_accuracy': 'Точность', 'stat_support': 'Поддержка', 'btn_start': 'Начать',
            'slide2_title': '<span>VIP</span> статус в Pocket Option', 'slide2_subtitle': 'Эксклюзивные сигналы, приоритетная поддержка и доступ к закрытому сообществу элитных трейдеров.',
            'benefit_vip_signals': 'VIP сигналы: <b>20+/день</b>', 'benefit_vip_accuracy': 'VIP точность: <b>до 95%</b>', 'btn_next': 'Далее',
            'slide3_title': 'Начните <span>зарабатывать</span>', 'slide3_subtitle': 'Присоединяйтесь к тысячам успешных трейдеров и начните получать стабильную прибыль уже сегодня.',
            'stat_profit': 'Прибыль', 'slide3_profit': 'до 95%', 'stat_speed': 'Скорость', 'slide3_speed': '1-15 мин.', 'btn_start_trading': 'Начать торговать',
            'slide4_title': 'Регистрация в <span>Pocket Option</span>', 'slide4_subtitle': 'Чтобы получать сигналы, вам необходимо зарегистрироваться у надежного брокера.',
            'benefit1': 'Лицензированный брокер', 'benefit2': 'Быстрые выплаты', 'benefit3': 'Мин. депозит $10', 'btn_register': 'Зарегистрироваться',
            'post_reg_title': 'Классно! Стартуем', 'post_reg_subtitle': 'И помни, что с любой суммой можно достичь высот! Теперь сделай депозит. Я проверю зачисление депозита. Не шути со мной.', 'post_reg_button': 'Сделать депозит',
            'post_dep_title': 'Супер!', 'post_dep_subtitle_p1': 'Твой депозит пополнен. Вот твоя точка А - ', 'post_dep_subtitle_p2': 'За 5-10 сигналов, можно сделать ',
            'post_dep_subtitle_p3': 'Не бойся потерь, они есть у всех. В долгосроке ты обязательно заработаешь!', 'btn_get_vip_signal': 'Получить VIP сигнал',
            'searching_title_vip': 'Ищу VIP сигнал...', 'searching_subtitle_vip': 'Подготовься, зайди на платформу, надо будет действовать быстро.'
        },
        'en': {
            'error_text': 'Error: User not identified.<br>Please open the app via the "Menu" button in the bot.',
            'slide1_title': '<span>Premium</span> Signals for Pocket Option', 'slide1_subtitle': 'Get accurate trading signals from professional analysts with up to 95% accuracy.',
            'stat_traders': 'Traders', 'stat_accuracy': 'Accuracy', 'stat_support': 'Support', 'btn_start': 'Start',
            'slide2_title': '<span>VIP</span> Status in Pocket Option', 'slide2_subtitle': 'Exclusive signals, priority support and access to a closed community of elite traders.',
            'benefit_vip_signals': 'VIP signals: <b>20+/day</b>', 'benefit_vip_accuracy': 'VIP accuracy: <b>up to 95%</b>', 'btn_next': 'Next',
            'slide3_title': 'Start <span>Earning</span>', 'slide3_subtitle': 'Join thousands of successful traders and start getting stable profit today.',
            'stat_profit': 'Profit', 'slide3_profit': 'up to 95%', 'stat_speed': 'Speed', 'slide3_speed': '1-15 min.', 'btn_start_trading': 'Start Trading',
            'slide4_title': 'Registration in <span>Pocket Option</span>', 'slide4_subtitle': 'To receive signals, you need to register with a reliable broker.',
            'benefit1': 'Licensed broker', 'benefit2': 'Fast payouts', 'benefit3': 'Minimum deposit $10', 'btn_register': 'Register',
            'post_reg_title': 'Great! Let\'s start', 'post_reg_subtitle': 'Remember, you can reach great heights with any amount! Now make a deposit. I will check the deposit. Don\'t mess with me.', 'post_reg_button': 'Make a Deposit',
            'post_dep_title': 'Awesome!', 'post_dep_subtitle_p1': 'Your deposit has been credited. Here is your starting point A - ', 'post_dep_subtitle_p2': 'In 5-10 signals, you can make ',
            'post_dep_subtitle_p3': 'Don\'t be afraid of losses; everyone has them. In the long run, you will definitely earn!', 'btn_get_vip_signal': 'Get VIP Signal',
            'searching_title_vip': 'Searching for a VIP signal...', 'searching_subtitle_vip': 'Get ready, go to the platform, you\'ll need to act fast.'
        }
    };
    
    function applyTranslations(lang) {
        const t = TRANSLATIONS[lang];
        document.querySelectorAll('[data-translate-key]').forEach(el => {
            const key = el.getAttribute('data-translate-key');
            if (t[key]) el.innerHTML = t[key];
        });
    }

    function showView(viewElement) {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        if(viewElement) viewElement.classList.add('active');
    }

    document.addEventListener('DOMContentLoaded', function() {
        if (!tg.initDataUnsafe || !tg.initDataUnsafe.user) {
            const lang = (navigator.language && navigator.language.startsWith('ru')) ? 'ru' : 'en';
            applyTranslations(lang);
            showView(document.getElementById('error-view'));
            document.body.classList.add('ready');
            return;
        }

        const user = tg.initDataUnsafe.user;
        const userId = user.id;
        const userLang = (user.language_code && user.language_code.startsWith('ru')) ? 'ru' : 'en';
        
        document.documentElement.lang = userLang;
        applyTranslations(userLang);

        const onboardingFlow = document.getElementById('onboarding-flow');
        const postRegWelcomeView = document.getElementById('post-reg-welcome-view');
        const postDepositView = document.getElementById('post-deposit-view');
        const vipSignalSearchView = document.getElementById('vip-signal-search-view');
        const errorView = document.getElementById('error-view');
        let currentSlide = 0;

        function goToSlide(slideIndex) {
            onboardingFlow.style.transform = `translateX(-${slideIndex * 100}%)`;
            currentSlide = slideIndex;
        }

        document.querySelectorAll('.next-btn').forEach(btn => btn.addEventListener('click', () => goToSlide(currentSlide + 1)));
        document.querySelectorAll('.back-btn').forEach(btn => btn.addEventListener('click', () => goToSlide(currentSlide - 1)));
        
        const registrationLink = `https://u3.shortink.io/register?utm_campaign=825192&utm_source=affiliate&utm_medium=sr&a=PDSrNY9vG5LpeF&ac=1d&code=50START&sub_id1=${userId}`;
        document.getElementById('register-btn').addEventListener('click', () => tg.openLink(registrationLink));
        document.getElementById('deposit-btn').addEventListener('click', () => tg.openLink(registrationLink));
        
        document.getElementById('go-to-signals-btn').addEventListener('click', () => showView(vipSignalSearchView));
        
        // --- Main Routing Logic ---
        showView(document.getElementById('loader-view'));

        fetch(`/user/${userId}/data`, { cache: 'no-cache' })
            .then(res => res.json())
            .then(data => {
                if (!data.is_registered) {
                    showView(onboardingFlow);
                    goToSlide(0); // ← это добавляем
                } else {
                    const depositEvents = data.events.filter(e => e[0] === 'FTD' || e[0] === 'dep');
                    if (depositEvents.length > 0) {
                        const firstDeposit = depositEvents.find(e => e[0] === 'FTD') || depositEvents[depositEvents.length - 1];
                        const depositAmount = firstDeposit[1];
                        
                        document.getElementById('deposit-amount').innerText = `$${depositAmount}`;
                        document.getElementById('potential-profit').innerText = `x3.3 ($${(depositAmount * 3.3).toFixed(2)})`;
                        showView(postDepositView);
                    } else {
                        showView(postRegWelcomeView);
                    }
                }
            })
            .catch((error) => {
                console.error("Fetch error:", error);
                showView(errorView);
            })
            .finally(() => {
                document.body.classList.add('ready');
            });
    });
</script>

</body>
</html>




