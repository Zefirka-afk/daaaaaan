<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Pocket pro</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>

<div class="app-wrapper">

    <!-- ЭКРАН0: ЗАГРУЗКА -->
    <div id="loader-view" class="view active">
        <div class="card">
            <div class="spinner"></div>
            <p data-translate-key="loading"></p>
        </div>
    </div>
    
    <!-- ЭКРАН 0.1: ОШИБКА -->
    <div id="error-view" class="view">
        <div class="card">
            <p data-translate-key="error_text"></p>
        </div>
    </div>

    <!-- БЛОК 1: ОНБОРДИНГ -->
    <div id="onboarding-1-view" class="view">
        <div class="card">
            <h1 class="title" data-translate-key="onb1_title"></h1>
            <h2 class="subtitle">Pocket Option</h2>
            <p class="description" data-translate-key="onb1_desc"></p>
            <div class="stats-container">
                <div class="stat-item"><div class="value">1000+</div><div class="label" data-translate-key="onb1_stat1"></div></div>
                <div class="stat-item"><div class="value">95%</div><div class="label" data-translate-key="onb1_stat2"></div></div>
                <div class="stat-item"><div class="value">24/7</div><div class="label" data-translate-key="onb1_stat3"></div></div>
            </div>
            <div class="nav-buttons full-width">
                <button class="main-button" id="btn-onb1-next" data-translate-key="start_btn"></button>
            </div>
        </div>
    </div>
    <div id="onboarding-2-view" class="view">
        <div class="card">
            <h1 class="title" data-translate-key="onb2_title"></h1>
            <h2 class="subtitle">Pocket Option</h2>
            <p class="description" data-translate-key="onb2_desc"></p>
            <ul class="features-list">
                <li><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path fill="currentColor" d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/></svg><span data-translate-key="onb2_feat1"></span></li>
                <li><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path fill="currentColor" d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/></svg><span data-translate-key="onb2_feat2"></span></li>
                <li><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path fill="currentColor" d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/></svg><span data-translate-key="onb2_feat3"></span></li>
            </ul>
            <div class="nav-buttons">
                <button class="back-button" id="btn-onb2-back" data-translate-key="back_btn"></button>
                <button class="main-button" id="btn-onb2-next" data-translate-key="next_btn"></button>
            </div>
        </div>
    </div>
    <div id="onboarding-3-view" class="view">
        <div class="card">
            <h1 class="title" data-translate-key="onb3_title"></h1>
            <h2 class="subtitle">Pocket Option</h2>
            <p class="description" data-translate-key="onb3_desc"></p>
             <ul class="features-list">
                <li><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path fill="currentColor" d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/></svg><span data-translate-key="onb3_feat1"></span></li>
                <li><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path fill="currentColor" d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/></svg><span data-translate-key="onb3_feat2"></span></li>
            </ul>
            <div class="nav-buttons">
                <button class="back-button" id="btn-onb3-back" data-translate-key="back_btn"></button>
                <button class="main-button" id="btn-onb3-next" data-translate-key="onb3_btn"></button>
            </div>
        </div>
    </div>
    <div id="onboarding-4-view" class="view">
        <div class="card">
            <h1 class="title" data-translate-key="onb4_title"></h1>
            <p class="description" data-translate-key="onb4_desc"></p>
            <ul class="features-list">
                <li><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path fill="currentColor" d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/></svg><span data-translate-key="onb4_feat1"></span></li>
                <li><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path fill="currentColor" d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/></svg><span data-translate-key="onb4_feat2"></span></li>
                <li><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path fill="currentColor" d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/></svg><span data-translate-key="onb4_feat3"></span></li>
            </ul>
            <div class="nav-buttons">
                <button class="back-button" id="btn-onb4-back" data-translate-key="back_btn"></button>
                <button class="main-button" id="btn-register" data-translate-key="onb4_btn"></button>
            </div>
        </div>
    </div>

    <!-- БЛОК 2: ПОСЛЕ РЕГИСТРАЦИИ -->
    <div id="post-reg-view" class="view">
        <div class="card">
            <h1 class="title" data-translate-key="postreg_title"></h1>
            <p class="description" data-translate-key="postreg_desc"></p>
            <p class="description" data-translate-key="postreg_warn"></p>
        </div>
    </div>

    <!-- БЛОК 3: ПОСЛЕ ДЕПОЗИТА -->
    <div id="post-deposit-view" class="view">
        <div class="card">
            <h1 class="title" data-translate-key="postdep_title"></h1>
            <p class="description" data-translate-key="postdep_desc"></p>
            <p class="description" data-translate-key="postdep_profit"></p>
            <div class="signal-buttons">
                <button class="signal-button" id="btn-vip-signal">
                    <div class="signal-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="28" height="28"><path fill="currentColor" d="M5 16L3 5l5.5 5L12 4l3.5 6L21 5l-2 11H5zm14 3c0 .55-.45 1-1 1H6c-.55 0-1-.45-1-1v-1h14v1z"/></svg>
                    </div>
                    <div class="signal-text">
                        <h3 data-translate-key="vip_signal_title"></h3>
                        <p data-translate-key="vip_signal_desc"></p>
                    </div>
                </button>
                <button class="signal-button" id="btn-simple-signal">
                    <div class="signal-icon">
                         <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="28" height="28"><path fill="currentColor" d="M7 2v11h3v9l7-12h-4l4-8z"/></svg>
                    </div>
                    <div class="signal-text">
                        <h3 data-translate-key="simple_signal_title"></h3>
                        <p data-translate-key="simple_signal_desc"></p>
                    </div>
                </button>
            </div>
        </div>
    </div>
    
    <!-- БЛОК 4: ЭКРАНЫ ДЕЙСТВИЙ -->
    <div id="wip-view" class="view">
        <div class="card">
            <h1 class="title" data-translate-key="wip_title"></h1>
            <p class="description" data-translate-key="wip_desc"></p>
            <div class="nav-buttons full-width">
                 <button class="back-button" id="btn-wip-back" data-translate-key="back_btn"></button>
            </div>
        </div>
    </div>
    
    <!-- Процесс получения сигнала -->
    <div id="signal-active-view" class="view">
        <div class="card signal-card">
            <div id="signal-stage-1"><p class="emoji-spinner">⏳</p><h1 class="title" data-translate-key="search_title"></h1><p class="description" data-translate-key="search_desc"></p></div>
            <div id="signal-stage-2" style="display: none;"><button class="main-button" id="btn-get-signal" data-translate-key="signal_get_btn"></button></div>
            <div id="signal-stage-3" style="display: none;">
                <p class="signal-step" id="signal-status-ready" data-translate-key="signal_ready"></p>
                <p class="signal-step" id="signal-pair"></p>
                <p class="signal-step" id="signal-status-exp-soon" data-translate-key="signal_exp_soon"></p>
                <p class="signal-step" id="signal-expiration" style="display: none;"></p>
            </div>
            <div id="signal-stage-4" style="display: none; margin-top: 20px;">
                <p class="description" data-translate-key="signal_confirm_prompt"></p>
                <button class="main-button" id="btn-confirm-ready" data-translate-key="signal_confirm_btn"></button>
            </div>
            <div id="signal-stage-5" style="display: none;">
                <p class="signal-step" id="signal-direction"></p>
                <div id="signal-result-container" style="display: none;">
                    <p class="signal-step signal-result" id="signal-result-win" data-translate-key="signal_win"></p>
                    <div id="signal-win-buttons" style="display: none;">
                        <div class="button-row">
                            <button class="action-button" id="btn-next-signal" data-translate-key="next_signal_btn"></button>
                            <button class="action-button vip" id="btn-goto-vip" data-translate-key="want_vip_btn"></button>
                        </div>
                        <button class="action-button lost full-width" id="btn-i-lost" data-translate-key="i_lost_btn"></button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ЭКРАН "Я ПРОИГРАЛ" -->
    <div id="loss-view" class="view">
        <div class="card">
            <h1 class="title" data-translate-key="loss_title"></h1>
            <p class="description" data-translate-key="loss_desc"></p>
            <div class="nav-buttons-vertical">
                <button class="main-button" id="btn-next-from-loss" data-translate-key="next_signal_btn"></button>
                <button class="secondary-button" id="btn-vip-from-loss" data-translate-key="want_vip_btn"></button>
            </div>
        </div>
    </div>

</div>

<script>
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();
    tg.setHeaderColor('#12171f');
    tg.setBackgroundColor('#12171f');

    const REGISTER_LINK_TEMPLATE = "https://u3.shortink.io/register?utm_campaign=825192&utm_source=affiliate&utm_medium=sr&a=PDSrNY9vG5LpeF&ac=1d&code=50START";
    
    const TRANSLATIONS = {
        'ru': {
            'loading': 'Загрузка данных...', 'error_text': 'Ошибка: не удалось определить пользователя. Пожалуйста, откройте приложение через кнопку "Меню" в боте.', 'start_btn': 'Начать >', 'next_btn': 'Далее >', 'back_btn': '< Назад',
            'onb1_title': 'Premium сигналы', 'onb1_desc': 'Получайте точные торговые сигналы от профессиональных аналитиков с точностью до 95%', 'onb1_stat1': 'Трейдеры', 'onb1_stat2': 'Точность', 'onb1_stat3': 'Поддержка',
            'onb2_title': 'VIP Статус', 'onb2_desc': 'Эксклюзивные сигналы, приоритетная поддержка и доступ к закрытому сообществу элитных трейдеров', 'onb2_feat1': 'Обычные сигналы: 5-10/день', 'onb2_feat2': 'VIP сигналы: 20+/день', 'onb2_feat3': 'Точность VIP: до 95%',
            'onb3_title': 'Начните зарабатывать', 'onb3_desc': 'Присоединяйтесь к тысячам успешных трейдеров и начните получать стабильную прибыль уже сегодня', 'onb3_feat1': 'Прибыль: до 95%', 'onb3_feat2': 'Скорость: 1-15 мин.', 'onb3_btn': 'Начать торговать >',
            'onb4_title': 'Регистрация в Pocket Option', 'onb4_desc': 'Чтобы получать сигналы, вам необходимо зарегистрироваться у надежного брокера', 'onb4_feat1': 'Лицензированный брокер', 'onb4_feat2': 'Быстрые выплаты', 'onb4_feat3': 'Минимальный депозит $10', 'onb4_btn': 'Зарегистрироваться >',
            'postreg_title': 'Классно! Стартуем', 'postreg_desc': 'И помни, что с любой суммой можно достичь высот!', 'postreg_warn': 'Теперь сделай депозит. Я проверю зачисление депозита, не шути со мной.',
            'postdep_title': 'Супер, твой депозит пополнен!', 'postdep_desc': 'Вот твоя точка А - <b>{deposit_sum}</b>', 'postdep_profit': 'За 5-10 сигналов можно сделать ~<b>{profit_sum}</b><br>Не бойся потерь, они есть у всех. В долгосроке ты обязательно заработаешь!',
            'vip_signal_title': '👑 ВИП Сигнал', 'vip_signal_desc': 'ВИП сигналы - самый надежный способ заработать на трейдинге. Здесь выдаются лучшие сигналы.', 'simple_signal_title': 'Простой сигнал', 'simple_signal_desc': 'Я пришлю валютную пару, время экспирации и сам сигнал (вверх или вниз). Готов?',
            'wip_title': 'В разработке', 'wip_desc': 'Эта функция скоро будет доступна.',
            'search_title': 'Я в поиске сигнала', 'search_desc': 'Подготовься, зайди на платформу, надо будет действовать быстро',
            'signal_get_btn': 'Получить сигнал', 'signal_ready': 'Готово!', 'signal_pair_select': 'Выбери валютную пару <b>{pair}</b>', 'signal_exp_soon': 'СЕЙЧАС скажу время экспирации', 'signal_exp_time': 'Время экспирации <b>{exp}</b>',
            'signal_buy': 'ПОКУПАЙ 🟢', 'signal_sell': 'ПРОДАВАЙ 🔴',
            'signal_confirm_prompt': 'Нажми, как только будешь готов действовать!', 'signal_confirm_btn': 'Я готов!',
            'signal_win': 'ПОБЕДА! 🏆',
            'next_signal_btn': 'Следующий!', 'want_vip_btn': 'Хочу ВИП сигнал', 'i_lost_btn': 'Я проиграл',
            'loss_title': 'Хм, странно! А я выиграл', 'loss_desc': 'Должно быть ты сделал что-то не так. Часто бывает так, что люди ставят не вовремя. Попробуй еще раз! Впредь будь внимательнее',
        },
        'en': { /* ... здесь должны быть ваши английские переводы ... */ }
    };

    let userLang = 'en';

    function applyTranslations(lang, data = {}) {
        const t = TRANSLATIONS[lang];
        document.querySelectorAll('[data-translate-key]').forEach(el => {
            const key = el.getAttribute('data-translate-key');
            if (t[key]) {
                let text = t[key];
                for(const dataKey in data) { text = text.replace(`{${dataKey}}`, data[dataKey]); }
                el.innerHTML = text;
            }
        });
    }

    function showView(viewId) {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        const viewElement = document.getElementById(viewId);
        if (viewElement) { viewElement.classList.add('active'); }
    }
    
    function startSignalFlow() {
        showView('signal-active-view');
        
        const stages = ['signal-stage-1', 'signal-stage-2', 'signal-stage-3', 'signal-stage-4', 'signal-stage-5'];
        stages.forEach(id => document.getElementById(id).style.display = 'none');
        document.getElementById('signal-stage-1').style.display = 'block';
        
        document.getElementById('signal-result-container').style.display = 'none';
        document.getElementById('signal-win-buttons').style.display = 'none';

        const getSignalBtn = document.getElementById('btn-get-signal');
        
        setTimeout(() => {
            document.getElementById('signal-stage-1').style.display = 'none';
            document.getElementById('signal-stage-2').style.display = 'block';
        }, 10000);

        getSignalBtn.onclick = () => {
            document.getElementById('signal-stage-2').style.display = 'none';
            document.getElementById('signal-stage-3').style.display = 'block';

            const currencyPairs = ["EUR/RUB OTC", "AUD/USD OTC", "AUD/CAD OTC", "GBP/USD OTC", "EUR/USD OTC"];
            const expirations = ["S15", "S20", "S25", "S30", "S45"];
            const directions = ["buy", "sell"];
            const getRandomItem = (arr) => arr[Math.floor(Math.random() * arr.length)];
            
            const selectedPair = getRandomItem(currencyPairs);
            const selectedExp = getRandomItem(expirations);
            const selectedDir = getRandomItem(directions);
            
            document.getElementById('signal-pair').innerHTML = TRANSLATIONS[userLang]['signal_pair_select'].replace('{pair}', selectedPair);

            setTimeout(() => {
                document.getElementById('signal-expiration').innerHTML = TRANSLATIONS[userLang]['signal_exp_time'].replace('{exp}', selectedExp);
                document.getElementById('signal-expiration').style.display = 'block';
                document.getElementById('signal-stage-4').style.display = 'block';
                
                const confirmReadyBtn = document.getElementById('btn-confirm-ready');

                confirmReadyBtn.onclick = () => {
                    document.getElementById('signal-stage-3').style.display = 'none';
                    document.getElementById('signal-stage-4').style.display = 'none';
                    document.getElementById('signal-stage-5').style.display = 'block';
                    
                    setTimeout(() => {
                        const signalDirectionEl = document.getElementById('signal-direction');
                        if (selectedDir === 'buy') {
                            signalDirectionEl.className = 'signal-step buy-signal';
                            signalDirectionEl.innerHTML = TRANSLATIONS[userLang]['signal_buy'];
                        } else {
                            signalDirectionEl.className = 'signal-step sell-signal';
                            signalDirectionEl.innerHTML = TRANSLATIONS[userLang]['signal_sell'];
                        }
                        signalDirectionEl.style.display = 'block';
                        
                        const timeValue = parseInt(selectedExp.substring(1));
                        const expirationInMs = timeValue * 1000;

                        setTimeout(() => {
                            document.getElementById('signal-result-container').style.display = 'block';
                            document.getElementById('signal-win-buttons').style.display = 'block'; 
                        }, expirationInMs);

                    }, 6000);
                };

            }, 7000);
        };
    }

    function setupNavigation() {
        document.getElementById('btn-onb1-next').onclick = () => showView('onboarding-2-view');
        document.getElementById('btn-onb2-back').onclick = () => showView('onboarding-1-view');
        document.getElementById('btn-onb2-next').onclick = () => showView('onboarding-3-view');
        document.getElementById('btn-onb3-back').onclick = () => showView('onboarding-2-view');
        document.getElementById('btn-onb3-next').onclick = () => showView('onboarding-4-view');
        document.getElementById('btn-onb4-back').onclick = () => showView('onboarding-3-view');
        document.getElementById('btn-vip-signal').onclick = () => showView('wip-view');
        document.getElementById('btn-simple-signal').onclick = startSignalFlow;
        document.getElementById('btn-wip-back').onclick = () => showView('post-deposit-view');
        
        document.getElementById('btn-next-signal').onclick = startSignalFlow;
        document.getElementById('btn-goto-vip').onclick = () => showView('wip-view');
        document.getElementById('btn-i-lost').onclick = () => showView('loss-view');
        document.getElementById('btn-next-from-loss').onclick = startSignalFlow;
        document.getElementById('btn-vip-from-loss').onclick = () => showView('wip-view');
    }
    
    async function main() {
        if (!tg.initDataUnsafe || !tg.initDataUnsafe.user) {
            applyTranslations('en');
            showView('error-view');
            return;
        }

        const user = tg.initDataUnsafe.user;
        const userId = user.id;
        userLang = (user.language_code && user.language_code.startsWith('ru')) ? 'ru' : 'en';
        document.documentElement.lang = userLang;
        
        applyTranslations(userLang);
        setupNavigation();
        
        document.getElementById('btn-register').onclick = () => {
            const personalLink = `${REGISTER_LINK_TEMPLATE}&sub_id1=${userId}`;
            tg.openLink(personalLink);
        };

        try {
            const response = await fetch(`/user/${userId}/data`);
            if (!response.ok) throw new Error('Network response was not ok');
            const data = await response.json();
            
            const hasDeposit = data.events.some(e => e[0] === 'FTD' || e[0] === 'dep');

            if (data.is_registered) {
                if (hasDeposit) {
                    const depositEvent = data.events.find(e => e[0] === 'FTD' || e[0] === 'dep');
                    const depositAmount = parseFloat(depositEvent[1]);
                    const profitAmount = (depositAmount * 3.3).toFixed(2);
                    
                    applyTranslations(userLang, {
                        deposit_sum: `$${depositAmount}`,
                        profit_sum: `$${profitAmount}`
                    });
                    showView('post-deposit-view');
                } else {
                    showView('post-reg-view');
                }
            } else {
                showView('onboarding-1-view');
            }
        } catch (error) {
            console.error("Data loading error:", error);
            showView('error-view');
        }
    }

    document.addEventListener('DOMContentLoaded', main);
</script>

</body>
</html>






