<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Pocket pro</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>

<div class="app-wrapper">

    <!-- ЭКРАН 0: ЗАГРУЗКА -->
    <div id="loader-view" class="view active"><div class="card"><div class="spinner"></div><p data-translate-key="loading"></p></div></div>
    
    <!-- ЭКРАН 0.1: ОШИБКА -->
    <div id="error-view" class="view"><div class="card"><p data-translate-key="error_text"></p></div></div>

    <!-- БЛОК 1: ОНБОРДИНГ (ИЗМЕНЕННЫЙ ПЕРВЫЙ ЭКРАН) -->
    <div id="onboarding-1-view" class="view">
        <div class="card">
            <h1 class="custom-header">PRO MAX TRAIDING SIGNAL BOT</h1>
            <p class="version-tag">v.5.0</p>
            
            <p class="ai-users-text" data-translate-key="onb1_ai_users"></p>
            
            <div class="stats-container">
                <div class="stat-item">
                    <div class="value">30 000+</div>
                    <div class="label" data-translate-key="onb1_stat_users"></div>
                </div>
                <div class="stat-item">
                    <div class="value">+$7M</div>
                    <div class="label" data-translate-key="onb1_stat_earned"></div>
                </div>
                <div class="stat-item">
                    <div class="value">TOP 1</div>
                    <div class="label" data-translate-key="onb1_stat_recommended"></div>
                </div>
            </div>
            
            <div class="nav-buttons full-width">
                <button class="main-button" id="btn-onb1-next" data-translate-key="next_btn"></button>
            </div>
            
            <p class="footer-credit">work with PO</p>
        </div>
    </div>
    
    <div id="onboarding-2-view" class="view"><div class="card"><h1 class="title" data-translate-key="onb2_title"></h1><h2 class="subtitle">Pocket Option</h2><p class="description" data-translate-key="onb2_desc"></p><ul class="features-list"><li><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path fill="currentColor" d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/></svg><span data-translate-key="onb2_feat1"></span></li><li><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path fill="currentColor" d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/></svg><span data-translate-key="onb2_feat2"></span></li><li><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path fill="currentColor" d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/></svg><span data-translate-key="onb2_feat3"></span></li></ul><div class="nav-buttons"><button class="back-button" id="btn-onb2-back" data-translate-key="back_btn"></button><button class="main-button" id="btn-onb2-next" data-translate-key="next_btn"></button></div></div></div>
    <div id="onboarding-3-view" class="view"><div class="card"><h1 class="title" data-translate-key="onb3_title"></h1><h2 class="subtitle">Pocket Option</h2><p class="description" data-translate-key="onb3_desc"></p><ul class="features-list"><li><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path fill="currentColor" d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/></svg><span data-translate-key="onb3_feat1"></span></li><li><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path fill="currentColor" d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/></svg><span data-translate-key="onb3_feat2"></span></li></ul><div class="nav-buttons"><button class="back-button" id="btn-onb3-back" data-translate-key="back_btn"></button><button class="main-button" id="btn-onb3-next" data-translate-key="onb3_btn"></button></div></div></div>
    
    <!-- Экран регистрации (onboarding-4-view) -->
    <div id="onboarding-4-view" class="view"><div class="card"><h1 class="title" data-translate-key="onb4_title"></h1><p class="description" data-translate-key="onb4_desc"></p><ul class="features-list"><li><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path fill="currentColor" d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/></svg><span data-translate-key="onb4_feat1"></span></li><li><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path fill="currentColor" d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/></svg><span data-translate-key="onb4_feat2"></span></li><li><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path fill="currentColor" d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/></svg><span data-translate-key="onb4_feat3"></span></li></ul><div class="nav-buttons-vertical"><button class="main-button" id="btn-register" data-translate-key="onb4_btn"></button><button class="secondary-button" id="btn-have-account" data-translate-key="have_account_btn"></button><button class="secondary-button" id="btn-how-to-register" data-translate-key="how_to_register_btn"></button></div><div class="nav-buttons"><button class="back-button" id="btn-onb4-back" data-translate-key="back_btn"></button></div></div></div>

    <!-- СЦЕНАРИЙ "УЖЕ ЕСТЬ АККАУНТ" -->
    <div id="have-account-view" class="view"><div class="card"><p class="description" data-translate-key="have_account_title"></p><div class="nav-buttons-vertical"><button class="main-button" id="btn-ok-register" data-translate-key="ok_register_btn"></button><button class="secondary-button" id="btn-dont-want" data-translate-key="dont_want_btn"></button></div><div class="nav-buttons"><button class="back-button" id="btn-have-account-back" data-translate-key="back_btn"></button></div></div></div>
    <div id="no-money-view" class="view"><div class="card"><h1 class="title" data-translate-key="no_money_title"></h1><p class="description" data-translate-key="no_money_desc"></p><div class="choice-buttons"><button class="choice-button" id="btn-choice-1">1</button><button class="choice-button" id="btn-choice-2">2</button><button class="choice-button" id="btn-choice-3">3</button><button class="choice-button" id="btn-choice-4">4</button></div><p class="description" data-translate-key="no_money_choice"></p><div class="nav-buttons"><button class="back-button" id="btn-no-money-back" data-translate-key="back_btn"></button></div></div></div>
    <div id="bebra-view" class="view"><div class="card"><p class="description" data-translate-key="bebra_text"></p><div class="nav-buttons-vertical"><button class="main-button" id="btn-not-a-loser" data-translate-key="not_a_loser_btn"></button></div><div class="nav-buttons"><button class="back-button" id="btn-bebra-back" data-translate-key="back_btn"></button></div></div></div>
    <div id="barrier-view" class="view"><div class="card"><p class="description" data-translate-key="barrier_text"></p><div class="nav-buttons-vertical"><button class="main-button" id="btn-barrier-register" data-translate-key="onb4_btn"></button><button class="secondary-button" id="btn-how-to-withdraw" data-translate-key="how_to_withdraw_btn"></button></div><div class="nav-buttons"><button class="back-button" id="btn-barrier-back" data-translate-key="back_btn"></button></div></div></div>
    <div id="withdraw-wip-view" class="view"><div class="card"><p class="description" data-translate-key="wip_desc"></p><div class="nav-buttons-vertical"><button class="main-button" id="btn-withdraw-register" data-translate-key="onb4_btn"></button></div><div class="nav-buttons"><button class="back-button" id="btn-withdraw-back" data-translate-key="back_btn"></button></div></div></div>
    <!-- КОНЕЦ СЦЕНАРИЯ -->

    <!-- БЛОК 2: ПОСЛЕ РЕГИСТРАЦИИ -->
    <div id="post-reg-view" class="view"><div class="card"><h1 class="title" data-translate-key="postreg_title"></h1><p class="description" data-translate-key="postreg_desc"></p><p class="description" data-translate-key="postreg_warn"></p><div class="nav-buttons-vertical" style="margin-top: 20px;"><button class="secondary-button" id="btn-how-to-deposit" data-translate-key="how_to_deposit_btn"></button></div></div></div>

    <!-- ЭКРАН: Как сделать депозит -->
    <div id="how-to-deposit-view" class="view"><div class="card"><p class="description" data-translate-key="how_to_deposit_text"></p><div class="nav-buttons"><button class="back-button" id="btn-how-to-deposit-back" data-translate-key="back_btn"></button></div></div></div>

    <!-- БЛОК 3: ПОСЛЕ ДЕПОЗИТА -->
    <div id="post-deposit-view" class="view"><div class="card"><h1 class="title" data-translate-key="postdep_title"></h1><p class="description" data-translate-key="postdep_desc"></p><p class="description" data-translate-key="postdep_profit"></p><div class="signal-buttons"><button class="signal-button" id="btn-vip-signal"><div class="signal-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="28" height="28"><path fill="currentColor" d="M5 16L3 5l5.5 5L12 4l3.5 6L21 5l-2 11H5zm14 3c0 .55-.45 1-1 1H6c-.55 0-1-.45-1-1v-1h14v1z"/></svg></div><div class="signal-text"><h3 data-translate-key="vip_signal_title"></h3><p data-translate-key="vip_signal_desc"></p></div></button><button class="signal-button" id="btn-simple-signal"><div class="signal-icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="28" height="28"><path fill="currentColor" d="M7 2v11h3v9l7-12h-4l4-8z"/></svg></div><div class="signal-text"><h3 data-translate-key="simple_signal_title"></h3><p data-translate-key="simple_signal_desc"></p></div></button></div></div></div>
    
    <!-- БЛОК 4: ЭКРАНЫ ДЕЙСТВИЙ -->
    <div id="wip-view" class="view"><div class="card"><h1 class="title" data-translate-key="wip_title"></h1><p class="description" data-translate-key="wip_desc"></p><div class="nav-buttons full-width"><button class="back-button" id="btn-wip-back"></button></div></div></div>
    
    <!-- Процесс получения сигнала -->
    <div id="signal-active-view" class="view"><div class="card signal-card"><div id="signal-stage-1"><p class="emoji-spinner">⏳</p><h1 class="title" data-translate-key="search_title"></h1><p class="description" data-translate-key="search_desc"></p></div><div id="signal-stage-2" style="display: none;"><button class="main-button" id="btn-get-signal" data-translate-key="signal_get_btn"></button></div><div id="signal-stage-3" style="display: none;"><p class="signal-step" id="signal-status-ready" data-translate-key="signal_ready"></p><p class="signal-step" id="signal-pair"></p><p class="signal-step" id="signal-exp-soon" data-translate-key="signal_exp_soon"></p><p class="signal-step" id="signal-expiration" style="display: none;"></p><div id="signal-confirmation-container" style="display: none; margin-top: 20px;"><button class="main-button" id="btn-confirm-ready" data-translate-key="confirm_ready_btn"></button></div><p class="signal-step" id="signal-direction" style="display: none;"></p><div id="signal-result-container" style="display: none;"><p class="signal-result" id="signal-result"></p><div id="signal-win-buttons" style="display: none;"><button class="action-button" id="btn-next-signal" data-translate-key="next_signal_btn"></button><button class="action-button vip" id="btn-goto-vip-from-win" data-translate-key="want_vip_btn"></button><button class="action-button lost" id="btn-i-lost" data-translate-key="i_lost_btn"></button></div><div id="signal-loss-buttons" style="display: none;"><button class="action-button" id="btn-next-from-loss-result" data-translate-key="next_signal_btn"></button><button class="action-button vip" id="btn-vip-from-loss-result" data-translate-key="want_vip_btn"></button></div></div></div></div></div>
    
    <!-- Экран проигрыша -->
    <div id="loss-view" class="view"><div class="card"><h1 class="title" data-translate-key="loss_title"></h1><p class="description" data-translate-key="loss_desc"></p><div class="nav-buttons-vertical"><button class="main-button" id="btn-next-from-loss" data-translate-key="next_signal_btn"></button><button class="secondary-button" id="btn-vip-from-loss" data-translate-key="want_vip_btn"></button></div></div></div>

</div>

<button id="faq-button" class="faq-button">?</button>

<script>
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();
    tg.setHeaderColor('#12171f');
    tg.setBackgroundColor('#12171f');

    const REGISTER_LINK_TEMPLATE = "https://u3.shortink.io/register?utm_campaign=825192&utm_source=affiliate&utm_medium=sr&a=PDSrNY9vG5LpeF&ac=1d&code=50START";
    
    const TRANSLATIONS = {
        'ru': {
            'loading': 'Загрузка данных...',
            'error_text': 'Ошибка: не удалось определить пользователя.',
            'next_btn': 'Далее >',
            'back_btn': '< Назад',
            // --- НОВЫЕ ПЕРЕВОДЫ ДЛЯ ПЕРВОГО ЭКРАНА ---
            'onb1_ai_users': '40+ трейдеров используют этого ИИ-бота',
            'onb1_stat_users': 'пользователей',
            'onb1_stat_earned': 'заработано',
            'onb1_stat_recommended': 'РЕКОМЕНДОВАНО',
            // --- ОСТАЛЬНЫЕ ПЕРЕВОДЫ ---
            'onb2_title': 'VIP Статус', 'onb2_desc': 'Эксклюзивные сигналы, приоритетная поддержка и доступ к закрытому сообществу элитных трейдеров', 'onb2_feat1': 'Обычные сигналы: 5-10/день', 'onb2_feat2': 'VIP сигналы: 20+/день', 'onb2_feat3': 'Точность VIP: до 95%', 'onb3_title': 'Начните зарабатывать', 'onb3_desc': 'Присоединяйтесь к тысячам успешных трейдеров и начните получать стабильную прибыль уже сегодня', 'onb3_feat1': 'Прибыль: до 95%', 'onb3_feat2': 'Скорость: 1-15 мин.', 'onb3_btn': 'Начать торговать >', 'onb4_title': 'Регистрация в Pocket Option', 'onb4_desc': 'Чтобы получать сигналы, вам необходимо зарегистрироваться у надежного брокера', 'onb4_feat1': 'Лицензированный брокер', 'onb4_feat2': 'Быстрые выплаты', 'onb4_feat3': 'Минимальный депозит $10', 'onb4_btn': 'Зарегистрироваться >', 'postreg_title': 'Классно! Стартуем', 'postreg_desc': 'И помни, что с любой суммой можно достичь высот!', 'postreg_warn': 'Теперь сделай депозит. Я проверю зачисление депозита, не шути со мной.', 'postdep_title': 'Супер, твой депозит пополнен!', 'postdep_desc': 'Вот твоя точка А - <b>${deposit_sum}</b>', 'postdep_profit': 'За 5-10 сигналов можно сделать ~<b>${profit_sum}</b><br>Не бойся потерь, они есть у всех. В долгосроке ты обязательно заработаешь!', 'vip_signal_title': '👑 ВИП Сигнал', 'vip_signal_desc': 'ВИП сигналы - самый надежный способ заработать на трейдинге.', 'simple_signal_title': 'Простой сигнал', 'simple_signal_desc': 'Я пришлю валютную пару, время экспирации и сам сигнал (вверх или вниз). Будь готов!', 'wip_title': 'В разработке', 'wip_desc': 'Эта функция скоро будет доступна.', 'search_title': 'Я в поиске сигнала', 'search_desc': 'Подготовься, зайди на платформу, надо будет действовать быстро', 'signal_get_btn': 'Получить сигнал', 'signal_ready': 'Готово!', 'signal_pair_select': 'Выбери валютную пару <b>{pair}</b>', 'signal_exp_time': 'Время экспирации <b>{exp}</b>', 'signal_exp_soon': 'СЕЙЧАС скажу время экспирации', 'signal_buy': 'ПОКУПАЙ 🟢', 'signal_sell': 'ПРОДАВАЙ 🔴', 'signal_win': 'ПОБЕДА', 'signal_loss': 'ПРОИГРЫШ', 'next_signal_btn': 'Следующий!', 'want_vip_btn': 'Хочу ВИП сигнал', 'i_lost_btn': 'Я проиграл', 'loss_title': 'Хм, странно! А я выиграл', 'loss_desc': 'Должно быть ты сделал что-то не так.', 'confirm_ready_btn': 'Я готов!', 'have_account_btn': 'У меня уже есть аккаунт', 'have_account_title': 'Окей, просто создай новый аккаунт, используя новую эл.почту', 'ok_register_btn': 'Ок, вернусь к регистрации', 'dont_want_btn': 'не хочу, не буду', 'no_money_title': 'Может быть ты и денег не хочешь? 😏', 'no_money_desc': 'Тот кто хочет, тот всегда найдет вариант:<br>1 — продолжать нюхать бебру<br>2 — зарегать акк на друга<br>3 — сделать все, чтобы вывести деньги со старого аккаунта и зарегать новый<br>4 — забить на остаток своих шекелей на старом акке', 'no_money_choice': 'Что выбираешь?', 'bebra_text': 'Ну продолжай нюхать бебру, если захочешь заработать самые легкие и честные деньги в своей жизни - нажми на кнопку👇', 'not_a_loser_btn': 'Я не буду ничтожеством', 'barrier_text': 'Значит проблема в том, что у тебя уже есть деньги на старом аккаунте и из-за этого ты не хочешь создавать новый.<br><br>Смотри сам, если у тебя стоит какой-то непреодолимый барьер, то попробуй выиграть сам или проиграй все. Хватит жалеть себя, будь решителен. Либо ты будешь зарабатывать на моих сигналах, либо будешь бесконечно торговать сам, не добиваясь феноменальных результатов.<br><br>Когда будешь готов зарегать новый акк - нажми на кнопку!👇', 'how_to_withdraw_btn': 'Как сделать вывод', 'how_to_deposit_btn': 'Как сделать деп?', 'how_to_deposit_text': '<i>*Скрины с помощью*</i>', 'how_to_register_btn': 'Как сделать регистрацию?',
        },
        'en': {
            'loading': 'Loading data...',
            'error_text': 'Error: User not identified.',
            'next_btn': 'Next >',
            'back_btn': '< Back',
             // --- NEW TRANSLATIONS FOR THE FIRST SCREEN ---
            'onb1_ai_users': '40+ signal-traders using this AI-Bot',
            'onb1_stat_users': 'users',
            'onb1_stat_earned': 'earned',
            'onb1_stat_recommended': 'RECOMMENDED',
            // --- OTHER TRANSLATIONS ---
            'onb2_title': 'VIP Status','onb2_desc': 'Exclusive signals, priority support and access to a closed community of elite traders','onb2_feat1': 'Regular signals: 5-10/day','onb2_feat2': 'VIP signals: 20+/day','onb2_feat3': 'VIP accuracy: up to 95%','onb3_title': 'Start Earning','onb3_desc': 'Join thousands of successful traders and start getting stable profit today','onb3_feat1': 'Profit: up to 95%','onb3_feat2': 'Speed: 1-15 min.','onb3_btn': 'Start Trading >','onb4_title': 'Registration in Pocket Option','onb4_desc': 'To receive signals, you need to register with a reliable broker','onb4_feat1': 'Licensed broker','onb4_feat2': 'Fast payouts','onb4_feat3': 'Minimum deposit $10','onb4_btn': 'Register >', 'postreg_title': 'Awesome! Let\'s start','postreg_desc': 'And remember, you can reach great heights with any amount!','postreg_warn': 'Now make a deposit. I will check the deposit, don\'t mess with me.','postdep_title': 'Super, your deposit is funded!','postdep_desc': 'Here is your starting point A - <b>${deposit_sum}</b>','postdep_profit': 'In 5-10 signals, you can make ~<b>${profit_sum}</b><br>Don\'t be afraid of losses, everyone has them. In the long run, you will definitely earn!', 'vip_signal_title': '👑 VIP Signal','vip_signal_desc': 'VIP signals are the most reliable way to earn in trading.','simple_signal_title': 'Simple Signal','simple_signal_desc': 'I will send you the currency pair, expiration time, and the signal itself (up or down). Be ready!', 'wip_title': 'Work in Progress','wip_desc': 'This feature will be available soon.','search_title': 'Searching for a signal','search_desc': 'Get ready, go to the platform, you will need to act quickly','signal_get_btn': 'Get Signal','signal_ready': 'Ready!','signal_pair_select': 'Choose currency pair <b>{pair}</b>','signal_exp_time': 'Expiration time <b>{exp}</b>', 'signal_exp_soon': 'I will tell you the expiration time NOW','signal_buy': 'BUY 🟢','signal_sell': 'SELL 🔴', 'signal_win': 'VICTORY', 'signal_loss': 'LOSS', 'next_signal_btn': 'Next Signal!','want_vip_btn': 'I want a VIP signal','i_lost_btn': 'I lost','loss_title': 'Hmm, strange! But I won','loss_desc': 'You must have done something wrong.','confirm_ready_btn': 'I\'m ready!', 'have_account_btn': 'I already have an account', 'have_account_title': 'Okay, just create a new account using a new email.', 'ok_register_btn': 'OK, back to registration', 'dont_want_btn': 'I don\'t want to', 'no_money_title': 'Maybe you don\'t want money either? 😏', 'no_money_desc': 'Those who want, will always find a way:<br>1 — Keep doing nothing<br>2 — Register an account for a friend<br>3 — Do everything to withdraw from the old account and register a new one<br>4 — Forget about the pennies on your old account', 'no_money_choice': 'What do you choose?', 'bebra_text': 'Well, keep doing nothing. When you want to earn the easiest and most honest money of your life - click the button below👇', 'not_a_loser_btn': 'I won\'t be a nobody', 'barrier_text': 'So the problem is you already have money in your old account, and that\'s why you don\'t want to create a new one.<br><br>Look, if you have some insurmountable barrier, try to win on your own or lose it all. Stop feeling sorry for yourself, be decisive. Either you will earn with my signals, or you will trade endlessly on your own, without achieving phenomenal results.<br><br>When you are ready to register a new account - click the button!👇', 'how_to_withdraw_btn': 'How to withdraw funds', 'how_to_deposit_btn': 'How to make a deposit?', 'how_to_deposit_text': '<i>*Screenshots with help*</i>', 'how_to_register_btn': 'How to register?',
        }
    };
    let userLang = 'en';
    let currentViewId = '';
    let previousViewId = '';

    function applyTranslations(lang, data = {}) {
        const t = TRANSLATIONS[lang];
        document.querySelectorAll('[data-translate-key]').forEach(el => {
            const key = el.getAttribute('data-translate-key');
            if (t[key]) {
                let text = t[key];
                for (const dataKey in data) { text = text.replace(`{${dataKey}}`, data[dataKey]); }
                el.innerHTML = text;
            }
        });
        document.getElementById('btn-wip-back').setAttribute('data-translate-key', 'back_btn');
        document.getElementById('btn-wip-back').innerHTML = t['back_btn'];
    }

    function showView(viewId) {
        if (currentViewId && currentViewId !== viewId) {
            previousViewId = currentViewId;
        }
        currentViewId = viewId;

        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        const viewElement = document.getElementById(viewId);
        if (viewElement) {
            viewElement.classList.add('active');
        }
        
        const faqButton = document.getElementById('faq-button');
        const faqVisibleOn = ['post-deposit-view', 'loss-view', 'post-reg-view'];
        
        if (faqVisibleOn.includes(viewId) || (viewId === 'wip-view' && faqVisibleOn.includes(previousViewId))) {
            faqButton.classList.add('visible');
        } else {
            faqButton.classList.remove('visible');
        }
    }

    function startSignalFlow() {
        showView('signal-active-view');
        document.getElementById('faq-button').classList.remove('visible');
        const stage1 = document.getElementById('signal-stage-1'), stage2 = document.getElementById('signal-stage-2'), stage3 = document.getElementById('signal-stage-3'), resultContainer = document.getElementById('signal-result-container'), winButtons = document.getElementById('signal-win-buttons'), lossButtons = document.getElementById('signal-loss-buttons'), confirmationContainer = document.getElementById('signal-confirmation-container'), signalStatusReady = document.getElementById('signal-status-ready'), signalPair = document.getElementById('signal-pair'), signalStatusExpSoon = document.getElementById('signal-exp-soon'), signalExpiration = document.getElementById('signal-expiration'), signalDirection = document.getElementById('signal-direction'), signalResult = document.getElementById('signal-result'), getSignalBtn = document.getElementById('btn-get-signal'), confirmReadyBtn = document.getElementById('btn-confirm-ready');
        stage1.style.display = 'block'; stage2.style.display = 'none'; stage3.style.display = 'none'; resultContainer.style.display = 'none'; winButtons.style.display = 'none'; lossButtons.style.display = 'none'; confirmationContainer.style.display = 'none';
        setTimeout(() => {
            stage1.style.display = 'none'; stage2.style.display = 'block'; document.getElementById('faq-button').classList.add('visible');
        }, 5000);
        getSignalBtn.onclick = () => {
            document.getElementById('faq-button').classList.remove('visible'); stage2.style.display = 'none'; stage3.style.display = 'block'; signalStatusReady.style.display = 'none'; signalPair.style.display = 'none'; signalStatusExpSoon.style.display = 'none'; signalExpiration.style.display = 'none'; confirmationContainer.style.display = 'none'; signalDirection.style.display = 'none'; resultContainer.style.display = 'none';
            const currencyPairs = ["EUR/RUB OTC", "AUD/USD OTC", "AUD/CAD OTC", "GBP/USD OTC", "EUR/USD OTC"], expirations = ["S15", "S20", "S25", "S30", "S45"], directions = ["buy", "sell"], getRandomItem = arr => arr[Math.floor(Math.random() * arr.length)], selectedPair = getRandomItem(currencyPairs), selectedExp = getRandomItem(expirations), selectedDir = getRandomItem(directions);
            setTimeout(() => { signalStatusReady.style.display = 'block'; }, 500);
            setTimeout(() => { signalPair.innerHTML = TRANSLATIONS[userLang]['signal_pair_select'].replace('{pair}', selectedPair); signalPair.style.display = 'block'; }, 1500);
            setTimeout(() => { signalStatusExpSoon.style.display = 'block'; }, 3000);
            setTimeout(() => { signalExpiration.innerHTML = TRANSLATIONS[userLang]['signal_exp_time'].replace('{exp}', selectedExp); signalExpiration.style.display = 'block'; confirmationContainer.style.display = 'block'; }, 10000);
            confirmReadyBtn.onclick = () => {
                confirmationContainer.style.display = 'none'; let dirText = selectedDir === 'buy' ? TRANSLATIONS[userLang]['signal_buy'] : TRANSLATIONS[userLang]['signal_sell']; signalDirection.className = `signal-step ${selectedDir}-signal`; signalDirection.innerHTML = dirText; signalDirection.style.display = 'block'; const expirationInMs = parseInt(selectedExp.substring(1)) * 1000;
                setTimeout(() => {
                    const isWin = Math.random() < 0.7;
                    if (isWin) { signalResult.innerHTML = TRANSLATIONS[userLang]['signal_win']; signalResult.className = 'signal-result win'; winButtons.style.display = 'flex'; }
                    else { signalResult.innerHTML = TRANSLATIONS[userLang]['signal_loss']; signalResult.className = 'signal-result loss'; lossButtons.style.display = 'flex'; }
                    resultContainer.style.display = 'block'; document.getElementById('faq-button').classList.add('visible');
                }, expirationInMs);
            };
        };
    }

    function setupNavigation() {
        document.getElementById('btn-onb1-next').onclick = () => showView('onboarding-2-view');
        document.getElementById('btn-onb2-back').onclick = () => showView('onboarding-1-view');
        document.getElementById('btn-onb2-next').onclick = () => showView('onboarding-3-view');
        document.getElementById('btn-onb3-back').onclick = () => showView('onboarding-2-view');
        document.getElementById('btn-onb3-next').onclick = () => showView('onboarding-4-view');
        document.getElementById('btn-onb4-back').onclick = () => showView('onboarding-3-view');
        document.getElementById('btn-vip-signal').onclick = () => showView('wip-view');
        document.getElementById('btn-simple-signal').onclick = startSignalFlow;
        document.getElementById('btn-wip-back').onclick = () => { if (previousViewId) { showView(previousViewId); } else { showView('post-deposit-view'); }};
        document.getElementById('btn-next-signal').onclick = startSignalFlow;
        document.getElementById('btn-goto-vip-from-win').onclick = () => showView('wip-view');
        document.getElementById('btn-i-lost').onclick = () => showView('loss-view');
        document.getElementById('btn-next-from-loss').onclick = startSignalFlow;
        document.getElementById('btn-vip-from-loss').onclick = () => showView('wip-view');
        document.getElementById('btn-next-from-loss-result').onclick = startSignalFlow;
        document.getElementById('btn-vip-from-loss-result').onclick = () => showView('wip-view');
        document.getElementById('faq-button').onclick = () => showView('wip-view');
        const openRegisterLink = () => { const userId = tg.initDataUnsafe.user.id; const personalLink = `${REGISTER_LINK_TEMPLATE}&sub_id1=${userId}`; tg.openLink(personalLink); };
        document.getElementById('btn-register').onclick = openRegisterLink;
        document.getElementById('btn-have-account').onclick = () => showView('have-account-view');
        document.getElementById('btn-have-account-back').onclick = () => showView('onboarding-4-view');
        document.getElementById('btn-dont-want').onclick = () => showView('no-money-view');
        document.getElementById('btn-no-money-back').onclick = () => showView('have-account-view');
        document.getElementById('btn-choice-1').onclick = () => showView('bebra-view');
        document.getElementById('btn-choice-3').onclick = () => showView('barrier-view');
        document.getElementById('btn-bebra-back').onclick = () => showView('no-money-view');
        document.getElementById('btn-barrier-back').onclick = () => showView('no-money-view');
        document.getElementById('btn-how-to-withdraw').onclick = () => showView('withdraw-wip-view');
        document.getElementById('btn-withdraw-back').onclick = () => showView('barrier-view');
        document.getElementById('btn-ok-register').onclick = () => showView('onboarding-4-view');
        document.getElementById('btn-choice-2').onclick = () => showView('onboarding-4-view');
        document.getElementById('btn-choice-4').onclick = () => showView('onboarding-4-view');
        document.getElementById('btn-not-a-loser').onclick = () => showView('onboarding-4-view');
        document.getElementById('btn-barrier-register').onclick = () => showView('onboarding-4-view');
        document.getElementById('btn-withdraw-register').onclick = () => showView('onboarding-4-view');
        document.getElementById('btn-how-to-deposit').onclick = () => showView('how-to-deposit-view');
        document.getElementById('btn-how-to-deposit-back').onclick = () => showView('post-reg-view');
        document.getElementById('btn-how-to-register').onclick = () => showView('wip-view');
    }

    async function fetchAndUpdateView(userId) {
        try {
            const response = await fetch(`/user/${userId}/data`);
            if (!response.ok) throw new Error('Network response was not ok');
            const data = await response.json();
            const hasDeposit = data.events.some(e => e[0] === 'FTD' || e[0] === 'dep');

            if (data.is_registered) {
                if (hasDeposit) {
                    const depositEvent = data.events.find(e => e[0] === 'FTD' || e[0] === 'dep');
                    const depositAmount = parseFloat(depositEvent[1]);
                    const profitAmount = (depositAmount * 2.5).toFixed(2);
                    applyTranslations(userLang, { deposit_sum: `${depositAmount.toFixed(2)}`, profit_sum: `${profitAmount}` });
                    showView('post-deposit-view');
                } else {
                    showView('post-reg-view');
                }
            } else {
                showView('onboarding-1-view');
            }
        } catch (error) {
            console.error("Data loading error:", error);
            showView('error-view');
        }
    }

    async function main() {
        if (!tg.initDataUnsafe || !tg.initDataUnsafe.user) {
            applyTranslations('en');
            showView('error-view');
            return;
        }
        const user = tg.initDataUnsafe.user;
        const userId = user.id;
        userLang = (user.language_code && user.language_code.startsWith('ru')) ? 'ru' : 'en';
        document.documentElement.lang = userLang;
        
        applyTranslations(userLang);
        setupNavigation();
        
        await fetchAndUpdateView(userId);

        const socket = io();
        socket.on('connect', () => {
            console.log('Connected to WebSocket server!');
            socket.emit('join', { 'chat_id': userId });
        });
        socket.on('update_data', (data) => {
            console.log('Received update from server:', data.message);
            tg.HapticFeedback.notificationOccurred('success');
            fetchAndUpdateView(userId);
        });
    }

    document.addEventListener('DOMContentLoaded', main);
</script>

</body>
</html>
