<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Pocket pro</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>

<!-- ВСПЛЫВАЮЩИЙ БЛОК С СОВЕТОМ -->
<div id="pro-tip-overlay" class="overlay-view">
    <div class="card pro-tip-card">
        <h2 class="subtitle" data-translate-key="pro_tip_title"></h2>
        <p class="description" data-translate-key="pro_tip_desc"></p>
        <button class="main-button" id="btn-pro-tip-ok" data-translate-key="pro_tip_btn"></button>
    </div>
</div>

<div class="app-wrapper">

    <!-- ЭКРАН 0: ЗАГРУЗКА -->
    <div id="loader-view" class="view active"><div class="card"><div class="spinner"></div><p data-translate-key="loading"></p></div></div>
    
    <!-- ЭКРАН 0.1: ОШИБКА -->
    <div id="error-view" class="view"><div class="card"><p data-translate-key="error_text"></p></div></div>

    <!-- БЛОК 1: ПЕРВЫЙ ЭКРАН -->
    <div id="onboarding-1-view" class="view">
        <div class="card">
            <h1 class="custom-header">PRO MAX TRAIDING SIGNAL BOT</h1>
            <p class="version-tag">v.5.0</p>
            <p class="ai-users-text" data-translate-key="onb1_ai_users"></p>
            <div class="stats-container">
                <div class="stat-item"><div class="value">30 000+</div><div class="label" data-translate-key="onb1_stat_users"></div></div>
                <div class="stat-item"><div class="value">+$7M</div><div class="label" data-translate-key="onb1_stat_earned"></div></div>
                <div class="stat-item"><div class="value">TOP 1</div><div class="label" data-translate-key="onb1_stat_recommended"></div></div>
            </div>
            <div class="nav-buttons full-width"><button class="main-button" id="btn-onb1-next" data-translate-key="next_btn"></button></div>
            <p class="footer-credit">work with PO</p>
        </div>
    </div>
    
    <!-- БЛОК 1.2: ТУТОРИАЛ -->
    <div id="onboarding-2-view" class="view">
        <div class="card">
            <h1 class="tutorial-title" data-translate-key="tutorial_title"></h1>
            <div class="tutorial-blocks">
                <div class="tutorial-block"><div class="number-circle">1</div><p data-translate-key="tutorial_b1"></p></div>
                <div class="tutorial-block"><div class="number-circle">2</div><p data-translate-key="tutorial_b2"></p></div>
                <div class="tutorial-block"><div class="number-circle">3</div><p data-translate-key="tutorial_b3"></p></div>
                <div class="tutorial-block"><div class="number-circle">4</div><p data-translate-key="tutorial_b4"></p></div>
            </div>
            <div class="nav-buttons">
                 <button class="back-button" id="btn-tutorial-back" data-translate-key="back_btn"></button>
                 <button class="main-button" id="btn-tutorial-ready" data-translate-key="tutorial_ready_btn"></button>
            </div>
        </div>
    </div>

    <!-- БЛОК 1.3: ШАГ I - РЕГИСТРАЦИЯ -->
    <div id="onboarding-3-view" class="view">
        <div class="card">
            <p class="step-label" data-translate-key="step1_label"></p>
            <h1 class="roman-numeral">I</h1>
            <h2 class="step-title" data-translate-key="step1_title"></h2>
            <div class="side-note"><p data-translate-key="step1_side_note"></p></div>
            <div class="nav-buttons-vertical">
                <button class="main-button" id="btn-step1-register" data-translate-key="step1_btn_register"></button>
                <button class="secondary-button" id="btn-step1-how-to" data-translate-key="how_to_register_btn"></button>
                <button class="secondary-button" id="btn-step1-have-account" data-translate-key="have_account_btn"></button>
            </div>
            <div class="nav-buttons"><button class="back-button" id="btn-step1-back" data-translate-key="back_btn"></button></div>
        </div>
    </div>
    
    <!-- СЦЕНАРИЙ "УЖЕ ЕСТЬ АККАУНТ" (без изменений) -->
    <!-- Экран 1: Проверка на реальные деньги -->
    <div id="real-money-check-view" class="view"><div class="card"><h1 class="title" data-translate-key="real_money_q"></h1><div class="nav-buttons-vertical"><button class="main-button" id="btn-real-money-yes" data-translate-key="yes_btn"></button><button class="secondary-button" id="btn-real-money-no" data-translate-key="no_btn"></button></div><div class="nav-buttons"><button class="back-button" id="btn-real-money-back" data-translate-key="back_btn"></button></div></div></div>
    <!-- Экран 2 (ответ "НЕТ"): Инструкции -->
    <div id="new-account-flow-view" class="view"><div class="card"><h1 class="title" data-translate-key="new_acc_flow_title"></h1><p class="description" data-translate-key="new_acc_flow_subtitle"></p><div class="flow-step"><div class="step-content"><span class="step-number">1</span><p data-translate-key="new_acc_flow_step1"></p></div><button class="secondary-button" id="btn-how-and-why-delete" data-translate-key="new_acc_flow_btn1"></button></div><div class="flow-step"><div class="step-content"><span class="step-number">2</span><p data-translate-key="new_acc_flow_step2"></p></div><button class="main-button" id="btn-new-acc-register" data-translate-key="step1_btn_register"></button><button class="secondary-button" id="btn-new-acc-how-to" data-translate-key="how_to_register_btn"></button></div><div class="important-note" data-translate-key="new_acc_flow_note"></div><div class="nav-buttons"><button class="back-button" id="btn-new-acc-back" data-translate-key="back_btn"></button></div></div></div>
    <!-- Экран 3 (ответ "НЕТ"): Инструкция по удалению -->
    <div id="how-to-delete-view" class="view"><div class="card"><h1 class="title" data-translate-key="how_to_del_title"></h1><ul class="delete-guide"><li data-translate-key="how_to_del_s1"></li><li data-translate-key="how_to_del_s2"></li><li data-translate-key="how_to_del_s3"></li><li data-translate-key="how_to_del_s4"></li><li data-translate-key="how_to_del_s5"></li></ul><div class="video-placeholder" data-translate-key="how_to_del_video_placeholder"></div><div class="nav-buttons"><button class="back-button" id="btn-delete-guide-back" data-translate-key="back_btn"></button></div></div></div>
    <!-- Экран 4 (ответ "ДА"): Варианты -->
    <div id="have-money-options-view" class="view"><div class="card"><h1 class="title" data-translate-key="have_money_title"></h1><p class="description" data-translate-key="have_money_subtitle"></p><div class="flow-step"><div class="step-content"><span class="step-number">1</span><p data-translate-key="have_money_opt1"></p></div><button class="secondary-button" id="btn-how-to-withdraw" data-translate-key="have_money_btn1"></button></div><div class="flow-step"><div class="step-content"><span class="step-number">2</span><p data-translate-key="have_money_opt2"></p></div><button class="main-button" id="btn-register-for-friend" data-translate-key="step1_btn_register"></button></div><div class="flow-step"><div class="step-content"><span class="step-number">3</span><p data-translate-key="have_money_opt3"></p></div><button class="secondary-button question-btn" id="btn-risk-what" data-translate-key="have_money_btn3"></button></div><div class="nav-buttons"><button class="back-button" id="btn-options-back" data-translate-key="back_btn"></button></div></div></div>
    <!-- Экран 5 (ответ "ДА"): Объяснение риска -->
    <div id="risk-info-view" class="view"><div class="card"><p class="risk-info-text" data-translate-key="risk_info_text"></p><div class="nav-buttons"><button class="back-button" id="btn-risk-info-back" data-translate-key="back_btn"></button></div></div></div>
    <!-- КОНЕЦ СЦЕНАРИЯ -->

    <!-- ЭКРАН: УСПЕШНАЯ РЕГИСТРАЦИЯ -->
    <div id="reg-success-view" class="view"><div class="card"><p class="success-emoji">✅</p><h1 class="title" data-translate-key="reg_success_title"></h1><p class="description" data-translate-key="reg_success_desc"></p><div class="nav-buttons full-width"><button class="main-button" id="btn-reg-success-next" data-translate-key="next_btn"></button></div></div></div>

    <!-- БЛОК 2: ШАГ II - ДЕПОЗИТ -->
    <div id="post-reg-view" class="view"><div class="card"><h1 class="step2-title" data-translate-key="step2_title"></h1><p class="description" data-translate-key="step2_subtitle"></p><div class="strategy-section"><div class="strategy-bubble" data-translate-key="step2_strategy_bubble"></div><div class="strategy-choices"><div class="strategy-card risk-on"><h3><span class="toggle on"></span><span data-translate-key="strat1_title"></span></h3><ul><li data-translate-key="strat1_li1"></li><li data-translate-key="strat1_li2"></li><li data-translate-key="strat1_li3"></li></ul></div><div class="strategy-card risk-off"><h3><span class="toggle off"></span><span data-translate-key="strat2_title"></span></h3><ul><li data-translate-key="strat2_li1"></li><li data-translate-key="strat2_li2"></li><li data-translate-key="strat2_li3"></li></ul></div></div></div><div class="nav-buttons-vertical"><button class="main-button" id="btn-make-deposit" data-translate-key="step2_btn_deposit"></button><button class="secondary-button" id="btn-how-to-deposit" data-translate-key="how_to_deposit_btn"></button></div></div></div>

    <!-- ЭКРАН: Как сделать депозит -->
    <div id="how-to-deposit-view" class="view"><div class="card"><p class="description" data-translate-key="how_to_deposit_text"></p><div class="nav-buttons"><button class="back-button" id="btn-how-to-deposit-back" data-translate-key="back_btn"></button></div></div></div>

    <!-- БЛОК 3: ПОСЛЕ ДЕПОЗИТА (НОВЫЙ ЭКРАН "ЛОББИ") -->
    <div id="post-deposit-view" class="view">
        <div class="card">
            <h1 class="lobby-title" data-translate-key="lobby_title"></h1>
            <p class="description" data-translate-key="lobby_congrats"></p>
            <div class="deposit-display">
                <div class="deposit-amount" id="deposit-amount-display"></div>
            </div>
            <p class="small-text" data-translate-key="lobby_footnote"></p>
            <div class="nav-buttons-vertical">
                <button class="secondary-button" id="btn-goto-profile" data-translate-key="lobby_btn_profile"></button>
            </div>
        </div>
    </div>
    
    <!-- БЛОК 4: ЭКРАНЫ ДЕЙСТВИЙ (без изменений) -->
    <div id="wip-view" class="view"><div class="card"><h1 class="title" data-translate-key="wip_title"></h1><p class="description" data-translate-key="wip_desc"></p><div class="nav-buttons full-width"><button class="back-button" id="btn-wip-back"></button></div></div></div>
    <div id="signal-active-view" class="view"><div class="card signal-card"><div id="signal-stage-1"><p class="emoji-spinner">⏳</p><h1 class="title" data-translate-key="search_title"></h1><p class="description" data-translate-key="search_desc"></p></div><div id="signal-stage-2" style="display: none;"><button class="main-button" id="btn-get-signal" data-translate-key="signal_get_btn"></button></div><div id="signal-stage-3" style="display: none;"><p class="signal-step" id="signal-status-ready" data-translate-key="signal_ready"></p><p class="signal-step" id="signal-pair"></p><p class="signal-step" id="signal-exp-soon" data-translate-key="signal_exp_soon"></p><p class="signal-step" id="signal-expiration" style="display: none;"></p><div id="signal-confirmation-container" style="display: none; margin-top: 20px;"><button class="main-button" id="btn-confirm-ready" data-translate-key="confirm_ready_btn"></button></div><p class="signal-step" id="signal-direction" style="display: none;"></p><div id="signal-result-container" style="display: none;"><p class="signal-result" id="signal-result"></p><div id="signal-win-buttons" style="display: none;"><button class="action-button" id="btn-next-signal" data-translate-key="next_signal_btn"></button><button class="action-button vip" id="btn-goto-vip-from-win" data-translate-key="want_vip_btn"></button><button class="action-button lost" id="btn-i-lost" data-translate-key="i_lost_btn"></button></div><div id="signal-loss-buttons" style="display: none;"><button class="action-button" id="btn-next-from-loss-result" data-translate-key="next_signal_btn"></button><button class="action-button vip" id="btn-vip-from-loss-result" data-translate-key="want_vip_btn"></button></div></div></div></div></div>
    <div id="loss-view" class="view"><div class="card"><h1 class="title" data-translate-key="loss_title"></h1><p class="description" data-translate-key="loss_desc"></p><div class="nav-buttons-vertical"><button class="main-button" id="btn-next-from-loss" data-translate-key="next_signal_btn"></button><button class="secondary-button" id="btn-vip-from-loss" data-translate-key="want_vip_btn"></button></div></div></div>

</div>

<button id="faq-button" class="faq-button">?</button>

<script>
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();
    tg.setHeaderColor('#12171f');
    tg.setBackgroundColor('#12171f');

    const REGISTER_LINK_TEMPLATE = "https://u3.shortink.io/register?utm_campaign=825192&utm_source=affiliate&utm_medium=sr&a=PDSrNY9vG5LpeF&ac=1d&code=50START";
    
    const TRANSLATIONS = {
        'ru': {
            'loading': 'Загрузка данных...', 'error_text': 'Ошибка: не удалось определить пользователя.', 'next_btn': 'Далее >', 'back_btn': '< Назад',
            'onb1_ai_users': '40+ трейдеров используют этого ИИ-бота', 'onb1_stat_users': 'пользователей', 'onb1_stat_earned': 'заработано', 'onb1_stat_recommended': 'РЕКОМЕНДОВАНО',
            'tutorial_title': 'Туториал', 'tutorial_b1': 'Подготовься перед сигналом, будь внимателен и бесстрашен.', 'tutorial_b2': 'Быстро открой сайт и повтори сделку за мной. Я дам инструкции, тут важна твоя <b>скорость</b>.', 'tutorial_b3': '8-12 сигналов: закрепи свою прибыль и не торопись её тратить. Продолжай торговать и умножай прибыль, будь рационален.', 'tutorial_b4': 'Получай звания и расти в рейтинге, чтобы получить доступ в сообщество самых успешных юзеров.', 'tutorial_ready_btn': 'Я готов!',
            'step1_label': 'ПЕРВЫЙ ШАГ', 'step1_title': 'Создай аккаунт', 'step1_side_note': 'У всех наших юзеров моментальные выводы благодаря лицензии P/O.', 'step1_btn_register': 'Зарегистрироваться', 'how_to_register_btn': 'Как сделать регистрацию?', 'have_account_btn': 'У меня уже есть аккаунт',
            'reg_success_title': 'Регистрация подтверждена!', 'reg_success_desc': 'Уже скоро ты получишь свой первый сигнал и начнёшь зарабатывать вместе с сотнями других трейдеров.',
            'step2_title': 'Финальный шаг, <em>сделай его!</em>', 'step2_subtitle': 'Определись с размером депозита.', 'step2_strategy_bubble': 'Выбери стратегию:', 'strat1_title': 'Риск включен', 'strat1_li1': 'Маленький депозит', 'strat1_li2': 'Проверка сигналов', 'strat1_li3': 'Бояться и играть по-крупному', 'strat2_title': 'Риск выключен', 'strat2_li1': 'Достойный депозит', 'strat2_li2': 'Быстрая прибыль', 'strat2_li3': 'Брать от жизни всё', 'step2_btn_deposit': 'Сделать депозит', 'how_to_deposit_btn': 'Как сделать депозит?',
            'real_money_q': 'Хорошо! Но на нём есть real money?', 'yes_btn': 'Да', 'no_btn': 'Нет', 'new_acc_flow_title': 'Хорошо! Чтобы использовать весь функционал бота и получать AI-signals, тебе нужен новый аккаунт.', 'new_acc_flow_subtitle': 'Поэтому для начала:', 'new_acc_flow_step1': 'Удали свой текущий аккаунт', 'new_acc_flow_btn1': 'Как и зачем удалять аккаунт?', 'new_acc_flow_step2': 'Создай новый аккаунт по этой кнопке', 'new_acc_flow_note': '! При регистрации нового аккаунта используй другую электронную почту.', 'how_to_del_title': 'Как удалить аккаунт?', 'how_to_del_s1': 'Перейди в свой профиль, где указаны твои личные данные.', 'how_to_del_s2': 'Пролистай в самый низ страницы.', 'how_to_del_s3': 'Нажми большую красную кнопку: "Delete account".', 'how_to_del_s4': 'Выбери <em>любую</em> причину и подтверди удаление.', 'how_to_del_s5': 'Выйди с аккаунта.', 'how_to_del_video_placeholder': '"тут будет видеоинструкция"',
            'have_money_title': 'Хорошо! Чтобы использовать весь функционал бота и получать AI-signals, тебе нужен новый аккаунт.', 'have_money_subtitle': 'У тебя есть несколько вариантов:', 'have_money_opt1': 'Вывести остаток денег, затем удалить аккаунт и создать новый.', 'have_money_btn1': 'Как вывести деньги с аккаунта?', 'have_money_opt2': 'Зарегистрировать аккаунт на друга.', 'have_money_opt3': 'Рискуй.', 'have_money_btn3': 'Что?', 'risk_info_text': 'Если денег на балансе мало – рискуй и иди до конца: либо все проиграешь, либо удвоишь. Мои сигналы окупят больше, чем твой остаток. <em>Действуй!</em>',
            'wip_title': 'В разработке', 'wip_desc': 'Эта функция скоро будет доступна.', 'search_title': 'Я в поиске сигнала', 'search_desc': 'Подготовься, зайди на платформу, надо будет действовать быстро', 'signal_get_btn': 'Получить сигнал', 'signal_ready': 'Готово!', 'signal_pair_select': 'Выбери валютную пару <b>{pair}</b>', 'signal_exp_time': 'Время экспирации <b>{exp}</b>', 'signal_exp_soon': 'СЕЙЧАС скажу время экспирации', 'signal_buy': 'ПОКУПАЙ 🟢', 'signal_sell': 'ПРОДАВАЙ 🔴', 'signal_win': 'ПОБЕДА', 'signal_loss': 'ПРОИГРЫШ', 'next_signal_btn': 'Следующий!', 'want_vip_btn': 'Хочу ВИП сигнал', 'i_lost_btn': 'Я проиграл', 'loss_title': 'Хм, странно! А я выиграл', 'loss_desc': 'Должно быть ты сделал что-то не так.', 'confirm_ready_btn': 'Я готов!', 'how_to_deposit_text': '<i>*Скрины с помощью*</i>',
            // НОВЫЕ ПЕРЕВОДЫ
            'pro_tip_title': 'Совет от про-трейдеров',
            'pro_tip_desc': 'Не бойся потерь, они есть у всех. В долгосроке все твои действия принесут прибыль!',
            'pro_tip_btn': 'OK!',
            'lobby_title': 'Лобби',
            'lobby_congrats': 'Поздравляю с первым депозитом!',
            'lobby_footnote': 'Это твоя отправная точка, не считая бонусы.',
            'lobby_btn_profile': 'Перейти в профиль трейдера',
        },
        'en': {
            'loading': 'Loading data...', 'error_text': 'Error: User not identified.', 'next_btn': 'Next >', 'back_btn': '< Back',
            'onb1_ai_users': '40+ signal-traders using this AI-Bot', 'onb1_stat_users': 'users', 'onb1_stat_earned': 'earned', 'onb1_stat_recommended': 'RECOMMENDED',
            'tutorial_title': 'Tutorial', 'tutorial_b1': 'Prepare before the signal, be attentive and fearless.', 'tutorial_b2': 'Quickly open the site and copy the trade after me. I will give instructions, your <b>speed</b> is important here.', 'tutorial_b3': '8-12 signals: secure your profit and don\'t rush to spend it. Keep trading and multiply your profit, be rational.', 'tutorial_b4': 'Get titles and grow in the rankings to gain access to the community of the most successful users.', 'tutorial_ready_btn': 'I\'m ready!',
            'step1_label': 'FIRST STEP', 'step1_title': 'Create an account', 'step1_side_note': 'All our users have instant withdrawals thanks to the P/O license.', 'step1_btn_register': 'Register', 'how_to_register_btn': 'How to register?', 'have_account_btn': 'I already have an account',
            'reg_success_title': 'Registration Confirmed!', 'reg_success_desc': 'Soon you will receive your first signal and start earning along with hundreds of other traders.',
            'step2_title': 'Final step, <em>make it!</em>', 'step2_subtitle': 'Decide on the deposit size.', 'step2_strategy_bubble': 'Choose a strategy:', 'strat1_title': 'Risk On', 'strat1_li1': 'Small deposit', 'strat1_li2': 'Testing signals', 'strat1_li3': 'Be afraid and play big', 'strat2_title': 'Risk Off', 'strat2_li1': 'Decent deposit', 'strat2_li2': 'Fast profit', 'strat2_li3': 'Take everything from life', 'step2_btn_deposit': 'Make a deposit', 'how_to_deposit_btn': 'How to make a deposit?',
            'real_money_q': 'Okay! But does it have real money?', 'yes_btn': 'Yes', 'no_btn': 'No', 'new_acc_flow_title': 'Okay! To use all bot functions and receive AI-signals, you need a new account.', 'new_acc_flow_subtitle': 'So to start:', 'new_acc_flow_step1': 'Delete your current account', 'new_acc_flow_btn1': 'How and why to delete the account?', 'new_acc_flow_step2': 'Create a new account using this button', 'new_acc_flow_note': '! When registering a new account, use a different email address.', 'how_to_del_title': 'How to delete the account?', 'how_to_del_s1': 'Go to your profile where your personal data is listed.', 'how_to_del_s2': 'Scroll to the very bottom of the page.', 'how_to_del_s3': 'Press the big red button: "Delete account".', 'how_to_del_s4': 'Choose <em>any</em> reason and confirm the deletion.', 'how_to_del_s5': 'Log out of the account.', 'how_to_del_video_placeholder': '"video guide will be here"',
            'have_money_title': 'Okay! To use all bot functions and receive AI-signals, you need a new account.', 'have_money_subtitle': 'You have several options:', 'have_money_opt1': 'Withdraw the remaining money, then delete the account and create a new one.', 'have_money_btn1': 'How to withdraw funds?', 'have_money_opt2': 'Register an account for a friend.', 'have_money_opt3': 'Take a risk.', 'have_money_btn3': 'What?', 'risk_info_text': 'If there is little money on the balance - take a risk and go all the way: either you lose everything, or you double it. My signals will pay off more than your balance. <em>Act!</em>',
            'wip_title': 'Work in Progress','wip_desc': 'This feature will be available soon.','search_title': 'Searching for a signal','search_desc': 'Get ready, go to the platform, you will need to act quickly','signal_get_btn': 'Get Signal','signal_ready': 'Ready!','signal_pair_select': 'Choose currency pair <b>{pair}</b>','signal_exp_time': 'Expiration time <b>{exp}</b>', 'signal_exp_soon': 'I will tell you the expiration time NOW','signal_buy': 'BUY 🟢','signal_sell': 'SELL 🔴', 'signal_win': 'VICTORY', 'signal_loss': 'LOSS', 'next_signal_btn': 'Next Signal!','want_vip_btn': 'I want a VIP signal','i_lost_btn': 'I lost','loss_title': 'Hmm, strange! But I won','loss_desc': 'You must have done something wrong.','confirm_ready_btn': 'I\'m ready!', 'how_to_deposit_text': '<i>*Screenshots with help*</i>',
            // NEW TRANSLATIONS
            'pro_tip_title': 'Advice from pro-traders',
            'pro_tip_desc': 'Don\'t be afraid of losses, everyone has them. In the long run, all your actions will bring profit!',
            'pro_tip_btn': 'OK!',
            'lobby_title': 'Lobby',
            'lobby_congrats': 'Congratulations on your first deposit!',
            'lobby_footnote': 'This is your starting point, not counting bonuses.',
            'lobby_btn_profile': 'Go to trader\'s profile',
        }
    };
    let userLang = 'en';
    let currentViewId = '';
    let previousViewId = '';
    let userId;

    function applyTranslations(lang) {
        const t = TRANSLATIONS[lang];
        document.querySelectorAll('[data-translate-key]').forEach(el => {
            const key = el.getAttribute('data-translate-key');
            if (t[key]) {
                el.innerHTML = t[key];
            }
        });
        if(document.getElementById('btn-wip-back')) {
            document.getElementById('btn-wip-back').setAttribute('data-translate-key', 'back_btn');
            document.getElementById('btn-wip-back').innerHTML = t['back_btn'];
        }
    }

    function showView(viewId) {
        if (currentViewId && currentViewId !== viewId) { previousViewId = currentViewId; }
        currentViewId = viewId;
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        const viewElement = document.getElementById(viewId);
        if (viewElement) { viewElement.classList.add('active'); }
        const faqButton = document.getElementById('faq-button');
        const faqVisibleOn = ['post-deposit-view', 'loss-view', 'post-reg-view', 'signal-active-view'];
        if (faqVisibleOn.includes(viewId) || (viewId === 'wip-view' && faqVisibleOn.includes(previousViewId))) {
            faqButton.classList.add('visible');
        } else {
            faqButton.classList.remove('visible');
        }
    }

    function startSignalFlow() {
        showView('signal-active-view');
        document.getElementById('faq-button').classList.remove('visible');
        const stage1 = document.getElementById('signal-stage-1'), stage2 = document.getElementById('signal-stage-2'), stage3 = document.getElementById('signal-stage-3'), resultContainer = document.getElementById('signal-result-container'), winButtons = document.getElementById('signal-win-buttons'), lossButtons = document.getElementById('signal-loss-buttons'), confirmationContainer = document.getElementById('signal-confirmation-container'), signalStatusReady = document.getElementById('signal-status-ready'), signalPair = document.getElementById('signal-pair'), signalStatusExpSoon = document.getElementById('signal-exp-soon'), signalExpiration = document.getElementById('signal-expiration'), signalDirection = document.getElementById('signal-direction'), signalResult = document.getElementById('signal-result'), getSignalBtn = document.getElementById('btn-get-signal'), confirmReadyBtn = document.getElementById('btn-confirm-ready');
        stage1.style.display = 'block'; stage2.style.display = 'none'; stage3.style.display = 'none'; resultContainer.style.display = 'none'; winButtons.style.display = 'none'; lossButtons.style.display = 'none'; confirmationContainer.style.display = 'none';
        setTimeout(() => {
            stage1.style.display = 'none'; stage2.style.display = 'block'; document.getElementById('faq-button').classList.add('visible');
        }, 5000);
        getSignalBtn.onclick = () => {
            document.getElementById('faq-button').classList.remove('visible'); stage2.style.display = 'none'; stage3.style.display = 'block'; signalStatusReady.style.display = 'none'; signalPair.style.display = 'none'; signalStatusExpSoon.style.display = 'none'; signalExpiration.style.display = 'none'; confirmationContainer.style.display = 'none'; signalDirection.style.display = 'none'; resultContainer.style.display = 'none';
            const currencyPairs = ["EUR/RUB OTC", "AUD/USD OTC", "AUD/CAD OTC", "GBP/USD OTC", "EUR/USD OTC"], expirations = ["S15", "S20", "S25", "S30", "S45"], directions = ["buy", "sell"], getRandomItem = arr => arr[Math.floor(Math.random() * arr.length)], selectedPair = getRandomItem(currencyPairs), selectedExp = getRandomItem(expirations), selectedDir = getRandomItem(directions);
            setTimeout(() => { signalStatusReady.style.display = 'block'; }, 500);
            setTimeout(() => { signalPair.innerHTML = TRANSLATIONS[userLang]['signal_pair_select'].replace('{pair}', selectedPair); signalPair.style.display = 'block'; }, 1500);
            setTimeout(() => { signalStatusExpSoon.style.display = 'block'; }, 3000);
            setTimeout(() => { signalExpiration.innerHTML = TRANSLATIONS[userLang]['signal_exp_time'].replace('{exp}', selectedExp); signalExpiration.style.display = 'block'; confirmationContainer.style.display = 'block'; }, 10000);
            confirmReadyBtn.onclick = () => {
                confirmationContainer.style.display = 'none'; let dirText = selectedDir === 'buy' ? TRANSLATIONS[userLang]['signal_buy'] : TRANSLATIONS[userLang]['signal_sell']; signalDirection.className = `signal-step ${selectedDir}-signal`; signalDirection.innerHTML = dirText; signalDirection.style.display = 'block'; const expirationInMs = parseInt(selectedExp.substring(1)) * 1000;
                setTimeout(() => {
                    const isWin = Math.random() < 0.7;
                    if (isWin) { signalResult.innerHTML = TRANSLATIONS[userLang]['signal_win']; signalResult.className = 'signal-result win'; winButtons.style.display = 'flex'; }
                    else { signalResult.innerHTML = TRANSLATIONS[userLang]['signal_loss']; signalResult.className = 'signal-result loss'; lossButtons.style.display = 'flex'; }
                    resultContainer.style.display = 'block'; document.getElementById('faq-button').classList.add('visible');
                }, expirationInMs);
            };
        };
    }

    function setupNavigation() {
        const openRegisterLink = () => { const personalLink = `${REGISTER_LINK_TEMPLATE}&sub_id1=${userId}`; tg.openLink(personalLink); };
        
        // НОВЫЕ КНОПКИ
        document.getElementById('btn-pro-tip-ok').onclick = () => {
            document.getElementById('pro-tip-overlay').style.display = 'none';
            showView('post-deposit-view');
        };
        document.getElementById('btn-goto-profile').onclick = () => showView('wip-view');
        
        // Главный путь онбординга
        document.getElementById('btn-onb1-next').onclick = () => showView('onboarding-2-view');
        document.getElementById('btn-tutorial-back').onclick = () => showView('onboarding-1-view');
        document.getElementById('btn-tutorial-ready').onclick = () => showView('onboarding-3-view');
        document.getElementById('btn-step1-back').onclick = () => showView('onboarding-2-view');
        document.getElementById('btn-step1-register').onclick = openRegisterLink;
        document.getElementById('btn-step1-how-to').onclick = () => showView('wip-view');
        document.getElementById('btn-reg-success-next').onclick = () => showView('post-reg-view');

        // Сценарий "Уже есть аккаунт"
        document.getElementById('btn-step1-have-account').onclick = () => showView('real-money-check-view');
        document.getElementById('btn-real-money-back').onclick = () => showView('onboarding-3-view');
        document.getElementById('btn-real-money-no').onclick = () => showView('new-account-flow-view');
        document.getElementById('btn-new-acc-back').onclick = () => showView('real-money-check-view');
        document.getElementById('btn-how-and-why-delete').onclick = () => showView('how-to-delete-view');
        document.getElementById('btn-new-acc-register').onclick = openRegisterLink;
        document.getElementById('btn-new-acc-how-to').onclick = () => showView('wip-view');
        document.getElementById('btn-delete-guide-back').onclick = () => showView('new-account-flow-view');
        document.getElementById('btn-real-money-yes').onclick = () => showView('have-money-options-view');
        document.getElementById('btn-options-back').onclick = () => showView('real-money-check-view');
        document.getElementById('btn-how-to-withdraw').onclick = () => showView('wip-view');
        document.getElementById('btn-register-for-friend').onclick = openRegisterLink;
        document.getElementById('btn-risk-what').onclick = () => showView('risk-info-view');
        document.getElementById('btn-risk-info-back').onclick = () => showView('have-money-options-view');

        // Экран депозита и далее
        document.getElementById('btn-make-deposit').onclick = openRegisterLink;
        document.getElementById('btn-how-to-deposit').onclick = () => showView('how-to-deposit-view');
        document.getElementById('btn-how-to-deposit-back').onclick = () => showView('post-reg-view');
        
        // Кнопки-заглушки
        document.getElementById('btn-wip-back').onclick = () => { if (previousViewId) { showView(previousViewId); } else { showView('post-deposit-view'); }};
        document.getElementById('faq-button').onclick = () => showView('wip-view');

        // Экраны внутри сигнала
        document.getElementById('btn-next-signal').onclick = startSignalFlow;
        document.getElementById('btn-goto-vip-from-win').onclick = () => showView('wip-view');
        document.getElementById('btn-i-lost').onclick = () => showView('loss-view');
        document.getElementById('btn-next-from-loss').onclick = startSignalFlow;
        document.getElementById('btn-vip-from-loss').onclick = () => showView('wip-view');
        document.getElementById('btn-next-from-loss-result').onclick = startSignalFlow;
        document.getElementById('btn-vip-from-loss-result').onclick = () => showView('wip-view');
    }

    async function fetchAndUpdateView(userId) {
        try {
            const response = await fetch(`/user/${userId}/data`);
            if (!response.ok) throw new Error('Network response was not ok');
            const data = await response.json();
            
            const ftdEvent = data.events.find(e => e[0] === 'FTD');
            const hasDeposit = ftdEvent || data.events.some(e => e[0] === 'dep');

            if (hasDeposit) {
                const depositEvent = ftdEvent || data.events.find(e => e[0] === 'dep');
                const depositAmount = parseFloat(depositEvent[1]).toFixed(2);
                
                // Всегда обновляем данные в лобби, даже если оно скрыто
                document.getElementById('deposit-amount-display').innerText = `$${depositAmount}`;

                // Показываем pop-up ТОЛЬКО при первом депозите (FTD) и если он еще не был показан в этой сессии
                const proTipSessionKey = `proTipShown_${userId}`;
                if (ftdEvent && !sessionStorage.getItem(proTipSessionKey)) {
                    sessionStorage.setItem(proTipSessionKey, 'true');
                    document.getElementById('pro-tip-overlay').style.display = 'flex';
                } else {
                    showView('post-deposit-view');
                }
            } else if (data.is_registered) {
                if(currentViewId !== 'post-reg-view') {
                    showView('reg-success-view'); 
                }
            } else {
                const onboardingViews = [
                    'onboarding-1-view', 'onboarding-2-view', 'onboarding-3-view', 
                    'real-money-check-view', 'new-account-flow-view', 'how-to-delete-view',
                    'have-money-options-view', 'risk-info-view'
                ];
                if (!onboardingViews.includes(currentViewId)) {
                    showView('onboarding-1-view');
                }
            }
        } catch (error) {
            console.error("Data loading error:", error);
            showView('error-view');
        }
    }

    async function main() {
        if (!tg.initDataUnsafe || !tg.initDataUnsafe.user) {
            applyTranslations('en');
            showView('error-view');
            return;
        }
        const user = tg.initDataUnsafe.user;
        userId = user.id; // Сохраняем userId в глобальную переменную
        userLang = (user.language_code && user.language_code.startsWith('ru')) ? 'ru' : 'en';
        document.documentElement.lang = userLang;
        
        applyTranslations(userLang);
        setupNavigation();
        
        await fetchAndUpdateView(userId);

        const socket = io();
        socket.on('connect', () => {
            console.log('Connected to WebSocket server!');
            socket.emit('join', { 'chat_id': userId });
        });
        socket.on('update_data', (data) => {
            console.log('Received update from server:', data.message);
            tg.HapticFeedback.notificationOccurred('success');
            fetchAndUpdateView(userId);
        });
    }

    document.addEventListener('DOMContentLoaded', main);
</script>

</body>
</html>
