<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Pocket pro</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>

<div class="app-wrapper">

    <!-- ЭКРАН 0: ЗАГРУЗКА -->
    <div id="loader-view" class="view active">
        <div class="card">
            <p class="spinner">⏳</p>
            <p data-translate-key="loading"></p>
        </div>
    </div>
    
    <!-- ЭКРАН 0.1: ОШИБКА -->
    <div id="error-view" class="view">
        <div class="card">
            <p data-translate-key="error_text"></p>
        </div>
    </div>

    <!-- БЛОК 1: ОНБОРДИНГ ДО РЕГИСТРАЦИИ -->
    <!-- Шаг 1.1 -->
    <div id="onboarding-1-view" class="view">
        <div class="card">
            <h1 class="title" data-translate-key="onb1_title"></h1>
            <h2 class="subtitle">Pocket Option</h2>
            <p class="description" data-translate-key="onb1_desc"></p>
            <div class="stats-container">
                <div class="stat-item"><div class="value">1000+</div><div class="label" data-translate-key="onb1_stat1"></div></div>
                <div class="stat-item"><div class="value">95%</div><div class="label" data-translate-key="onb1_stat2"></div></div>
                <div class="stat-item"><div class="value">24/7</div><div class="label" data-translate-key="onb1_stat3"></div></div>
            </div>
            <div class="nav-buttons full-width">
                <button class="main-button" id="btn-onb1-next" data-translate-key="start_btn"></button>
            </div>
        </div>
    </div>
    <!-- Шаг 1.2 -->
    <div id="onboarding-2-view" class="view">
        <div class="card">
            <h1 class="title" data-translate-key="onb2_title"></h1>
            <h2 class="subtitle">Pocket Option</h2>
            <p class="description" data-translate-key="onb2_desc"></p>
            <ul class="features-list">
                <li data-translate-key="onb2_feat1"></li>
                <li data-translate-key="onb2_feat2"></li>
                <li data-translate-key="onb2_feat3"></li>
            </ul>
            <div class="nav-buttons">
                <button class="back-button" id="btn-onb2-back" data-translate-key="back_btn"></button>
                <button class="main-button" id="btn-onb2-next" data-translate-key="next_btn"></button>
            </div>
        </div>
    </div>
    <!-- Шаг 1.3 -->
    <div id="onboarding-3-view" class="view">
        <div class="card">
            <h1 class="title" data-translate-key="onb3_title"></h1>
            <h2 class="subtitle">Pocket Option</h2>
            <p class="description" data-translate-key="onb3_desc"></p>
             <ul class="features-list">
                <li data-translate-key="onb3_feat1"></li>
                <li data-translate-key="onb3_feat2"></li>
            </ul>
            <div class="nav-buttons">
                <button class="back-button" id="btn-onb3-back" data-translate-key="back_btn"></button>
                <button class="main-button" id="btn-onb3-next" data-translate-key="onb3_btn"></button>
            </div>
        </div>
    </div>
    <!-- Шаг 1.4 -->
    <div id="onboarding-4-view" class="view">
        <div class="card">
            <h1 class="title" data-translate-key="onb4_title"></h1>
            <p class="description" data-translate-key="onb4_desc"></p>
            <ul class="features-list">
                <li data-translate-key="onb4_feat1"></li>
                <li data-translate-key="onb4_feat2"></li>
                <li data-translate-key="onb4_feat3"></li>
            </ul>
            <div class="nav-buttons">
                <button class="back-button" id="btn-onb4-back" data-translate-key="back_btn"></button>
                <button class="main-button" id="btn-register" data-translate-key="onb4_btn"></button>
            </div>
        </div>
    </div>

    <!-- БЛОК 2: ПОСЛЕ РЕГИСТРАЦИИ (ОЖИДАНИЕ ДЕПОЗИТА) -->
    <div id="post-reg-view" class="view">
        <div class="card">
            <h1 class="title" data-translate-key="postreg_title"></h1>
            <p class="description" data-translate-key="postreg_desc"></p>
            <p class="description" data-translate-key="postreg_warn"></p>
        </div>
    </div>

    <!-- БЛОК 3: ПОСЛЕ ДЕПОЗИТА (ВЫБОР СИГНАЛА) -->
    <div id="post-deposit-view" class="view">
        <div class="card">
            <h1 class="title" data-translate-key="postdep_title"></h1>
            <p class="description" data-translate-key="postdep_desc"></p>
            <p class="description" data-translate-key="postdep_profit"></p>
            <div class="signal-buttons">
                <div class="signal-button" id="btn-vip-signal">
                    <h3 data-translate-key="vip_signal_title"></h3>
                    <p data-translate-key="vip_signal_desc"></p>
                </div>
                <div class="signal-button" id="btn-simple-signal">
                    <h3 data-translate-key="simple_signal_title"></h3>
                    <p data-translate-key="simple_signal_desc"></p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- БЛОК 4: ЭКРАНЫ ДЕЙСТВИЙ -->
    <!-- WIP - В разработке -->
    <div id="wip-view" class="view">
        <div class="card">
            <h1 class="title" data-translate-key="wip_title"></h1>
            <p class="description" data-translate-key="wip_desc"></p>
            <div class="nav-buttons full-width">
                 <button class="back-button" id="btn-wip-back" data-translate-key="back_btn"></button>
            </div>
        </div>
    </div>

    <!-- НОВЫЙ БЛОК: Процесс получения сигнала -->
    <div id="signal-active-view" class="view">
        <div class="card signal-card">
            <div id="signal-stage-1">
                <p class="spinner">⏳</p>
                <h1 class="title" data-translate-key="search_title"></h1>
                <p class="description" data-translate-key="search_desc"></p>
            </div>

            <div id="signal-stage-2" style="display: none;">
                <button class="main-button" id="btn-get-signal" data-translate-key="signal_get_btn"></button>
            </div>

            <div id="signal-stage-3" style="display: none;">
                <p class="signal-step" id="signal-status-ready" data-translate-key="signal_ready"></p>
                <p class="signal-step" id="signal-pair"></p>
                <p class="signal-step" id="signal-status-exp-soon" data-translate-key="signal_exp_soon"></p>
                <p class="signal-step" id="signal-expiration" style="display: none;"></p>
                <p class="signal-step" id="signal-direction" style="display: none;"></p>
                <p class="signal-step signal-result" id="signal-result" style="display: none;"></p>
            </div>
            
            <div class="nav-buttons full-width" id="signal-back-container" style="display:none; margin-top: 30px;">
                <button class="back-button" id="btn-signal-back" data-translate-key="back_to_menu_btn"></button>
            </div>
        </div>
    </div>

</div>

<script>
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();
    tg.setHeaderColor('#18222d');
    tg.setBackgroundColor('#18222d');

    const REGISTER_LINK_TEMPLATE = "https://u3.shortink.io/register?utm_campaign=825192&utm_source=affiliate&utm_medium=sr&a=PDSrNY9vG5LpeF&ac=1d&code=50START";
    
    const TRANSLATIONS = {
        'ru': {
            'loading': 'Загрузка данных...',
            'error_text': 'Ошибка: не удалось определить пользователя. Пожалуйста, откройте приложение через кнопку "Меню" в боте.',
            'start_btn': 'Начать >',
            'next_btn': 'Далее >',
            'back_btn': '< Назад',
            'back_to_menu_btn': '< Вернуться в меню',
            // Onboarding 1
            'onb1_title': 'Premium сигналы', 'onb1_desc': 'Получайте точные торговые сигналы от профессиональных аналитиков с точностью до 95%',
            'onb1_stat1': 'Трейдеры', 'onb1_stat2': 'Точность', 'onb1_stat3': 'Поддержка',
            // Onboarding 2
            'onb2_title': 'VIP Статус', 'onb2_desc': 'Эксклюзивные сигналы, приоритетная поддержка и доступ к закрытому сообществу элитных трейдеров',
            'onb2_feat1': 'Обычные сигналы: 5-10/день', 'onb2_feat2': 'VIP сигналы: 20+/день', 'onb2_feat3': 'Точность VIP: до 95%',
            // Onboarding 3
            'onb3_title': 'Начните зарабатывать', 'onb3_desc': 'Присоединяйтесь к тысячам успешных трейдеров и начните получать стабильную прибыль уже сегодня',
            'onb3_feat1': 'Прибыль: до 95%', 'onb3_feat2': 'Скорость: 1-15 мин.', 'onb3_btn': 'Начать торговать >',
            // Onboarding 4
            'onb4_title': 'Регистрация в Pocket Option', 'onb4_desc': 'Чтобы получать сигналы, вам необходимо зарегистрироваться у надежного брокера',
            'onb4_feat1': 'Лицензированный брокер', 'onb4_feat2': 'Быстрые выплаты', 'onb4_feat3': 'Минимальный депозит $10', 'onb4_btn': 'Зарегистрироваться >',
            // Post-Reg
            'postreg_title': 'Классно! Стартуем', 'postreg_desc': 'И помни, что с любой суммой можно достичь высот!', 'postreg_warn': 'Теперь сделай депозит. Я проверю зачисление депозита, не шути со мной.',
            // Post-Deposit
            'postdep_title': 'Супер, твой депозит пополнен!', 'postdep_desc': 'Вот твоя точка А - <b>{deposit_sum}</b>', 'postdep_profit': 'За 5-10 сигналов можно сделать ~<b>{profit_sum}</b><br>Не бойся потерь, они есть у всех. В долгосроке ты обязательно заработаешь!',
            // Signal choice
            'vip_signal_title': '👑 ВИП Сигнал', 'vip_signal_desc': 'ВИП сигналы - самый надежный способ заработать на трейдинге. Здесь выдаются лучшие сигналы.',
            'simple_signal_title': 'Простой сигнал', 'simple_signal_desc': 'У тебя будет 30 секунд, чтобы подготовиться. Я пришлю валютную пару, время экспирации и сам сигнал (вверх или вниз). Готов?',
            // Other screens
            'wip_title': 'В разработке', 'wip_desc': 'Эта функция скоро будет доступна.',
            // Signal Flow
            'search_title': 'Я в поиске сигнала ⏳⏳⏳', 'search_desc': 'Подготовься, зайди на платформу, надо будет действовать быстро',
            'signal_get_btn': 'Получить сигнал',
            'signal_ready': 'Готово!',
            'signal_pair_select': 'Выбери валютную пару <b>{pair}</b>',
            'signal_exp_soon': 'СЕЙЧАС скажу время экспирации',
            'signal_exp_time': 'Время экспирации <b>{exp}</b>',
            'signal_buy': 'ПОКУПАЙ 🟢🟢🟢',
            'signal_sell': 'ПРОДАВАЙ 🔴🔴🔴',
            'signal_win': 'ПОБЕДА! 🏆',
        },
        'en': {
            'loading': 'Loading data...',
            'error_text': 'Error: User not identified. Please open the app via the "Menu" button in the bot.',
            'start_btn': 'Start >',
            'next_btn': 'Next >',
            'back_btn': '< Back',
            'back_to_menu_btn': '< Back to menu',
            // Onboarding 1
            'onb1_title': 'Premium Signals', 'onb1_desc': 'Get accurate trading signals from professional analysts with up to 95% accuracy',
            'onb1_stat1': 'Traders', 'onb1_stat2': 'Accuracy', 'onb1_stat3': 'Support',
            // Onboarding 2
            'onb2_title': 'VIP Status', 'onb2_desc': 'Exclusive signals, priority support and access to a closed community of elite traders',
            'onb2_feat1': 'Regular signals: 5-10/day', 'onb2_feat2': 'VIP signals: 20+/day', 'onb2_feat3': 'VIP accuracy: up to 95%',
            // Onboarding 3
            'onb3_title': 'Start Earning', 'onb3_desc': 'Join thousands of successful traders and start getting stable profit today',
            'onb3_feat1': 'Profit: up to 95%', 'onb3_feat2': 'Speed: 1-15 min.', 'onb3_btn': 'Start Trading >',
            // Onboarding 4
            'onb4_title': 'Registration in Pocket Option', 'onb4_desc': 'To receive signals, you need to register with a reliable broker',
            'onb4_feat1': 'Licensed broker', 'onb4_feat2': 'Fast payouts', 'onb4_feat3': 'Minimum deposit $10', 'onb4_btn': 'Register >',
            // Post-Reg
            'postreg_title': 'Awesome! Let\'s start', 'postreg_desc': 'And remember, you can reach great heights with any amount!', 'postreg_warn': 'Now make a deposit. I will check the deposit, don\'t mess with me.',
            // Post-Deposit
            'postdep_title': 'Super, your deposit is funded!', 'postdep_desc': 'Here is your starting point A - <b>{deposit_sum}</b>', 'postdep_profit': 'In 5-10 signals, you can make ~<b>{profit_sum}</b><br>Don\'t be afraid of losses, everyone has them. In the long run, you will definitely earn!',
            // Signal choice
            'vip_signal_title': '👑 VIP Signal', 'vip_signal_desc': 'VIP signals are the most reliable way to earn in trading. The best signals are given here.',
            'simple_signal_title': 'Simple Signal', 'simple_signal_desc': 'You will have 30 seconds to prepare. I will send you the currency pair, expiration time, and the signal itself (up or down). Ready?',
            // Other screens
            'wip_title': 'Work in Progress', 'wip_desc': 'This feature will be available soon.',
            // Signal Flow
            'search_title': 'Searching for a signal ⏳⏳⏳', 'search_desc': 'Get ready, go to the platform, you will need to act quickly',
            'signal_get_btn': 'Get Signal',
            'signal_ready': 'Ready!',
            'signal_pair_select': 'Choose currency pair <b>{pair}</b>',
            'signal_exp_soon': 'I will tell you the expiration time NOW',
            'signal_exp_time': 'Expiration time <b>{exp}</b>',
            'signal_buy': 'BUY 🟢🟢🟢',
            'signal_sell': 'SELL 🔴🔴🔴',
            'signal_win': 'WIN 🏆',
        }
    };

    let userLang = 'en'; // Default language

    function applyTranslations(lang, data = {}) {
        const t = TRANSLATIONS[lang];
        document.querySelectorAll('[data-translate-key]').forEach(el => {
            const key = el.getAttribute('data-translate-key');
            if (t[key]) {
                let text = t[key];
                for(const dataKey in data) {
                    text = text.replace(`{${dataKey}}`, data[dataKey]);
                }
                el.innerHTML = text;
            }
        });
    }

    function showView(viewId) {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        const viewElement = document.getElementById(viewId);
        if (viewElement) {
            viewElement.classList.add('active');
        }
    }
    
    // ===============================================
    // ========= НОВАЯ ЛОГИКА ДЛЯ СИГНАЛОВ =========
    // ===============================================
    function startSignalFlow() {
        showView('signal-active-view');

        // Сброс состояния до начального
        const stage1 = document.getElementById('signal-stage-1');
        const stage2 = document.getElementById('signal-stage-2');
        const stage3 = document.getElementById('signal-stage-3');
        stage1.style.display = 'block';
        stage2.style.display = 'none';
        stage3.style.display = 'none';
        document.getElementById('signal-back-container').style.display = 'none';
        document.getElementById('signal-result').style.display = 'none';
        
        // Получаем элементы для обновления
        const signalStatusReady = document.getElementById('signal-status-ready');
        const signalPair = document.getElementById('signal-pair');
        const signalStatusExpSoon = document.getElementById('signal-status-exp-soon');
        const signalExpiration = document.getElementById('signal-expiration');
        const signalDirection = document.getElementById('signal-direction');
        const signalResult = document.getElementById('signal-result');
        const getSignalBtn = document.getElementById('btn-get-signal');

        // --- Этап 1: Ожидание 10 секунд ---
        setTimeout(() => {
            stage1.style.display = 'none';
            stage2.style.display = 'block';
        }, 10000);

        // --- Этап 2: Нажатие кнопки "Получить сигнал" ---
        getSignalBtn.onclick = () => {
            stage2.style.display = 'none';
            stage3.style.display = 'block';
            
            // Показываем первые шаги
            signalStatusReady.style.display = 'block';
            signalPair.style.display = 'block';
            signalStatusExpSoon.style.display = 'block';
            
            // Скрываем последующие шаги
            signalExpiration.style.display = 'none';
            signalDirection.style.display = 'none';
            signalResult.style.display = 'none';

            // --- "Парсинг" и генерация данных ---
            // В реальности парсинг с сайта невозможен из-за CORS и авторизации.
            // Поэтому мы симулируем получение данных.
            const currencyPairs = ["EUR/RUB OTC", "AUD/USD OTC", "AUD/CAD OTC", "GBP/USD OTC", "EUR/USD OTC"];
            const expirations = ["M1", "M2", "S15", "S30", "S60"];
            const directions = ["buy", "sell"];
            const getRandomItem = (arr) => arr[Math.floor(Math.random() * arr.length)];
            
            const selectedPair = getRandomItem(currencyPairs);
            const selectedExp = getRandomItem(expirations);
            const selectedDir = getRandomItem(directions);
            
            // Устанавливаем текст для пары
            signalPair.innerHTML = TRANSLATIONS[userLang]['signal_pair_select'].replace('{pair}', selectedPair);

            // --- Этап 3: Появление времени экспирации через 7 секунд ---
            setTimeout(() => {
                signalExpiration.innerHTML = TRANSLATIONS[userLang]['signal_exp_time'].replace('{exp}', selectedExp);
                signalExpiration.style.display = 'block';

                // --- Этап 4: Появление направления через 6 секунд ---
                setTimeout(() => {
                    signalStatusExpSoon.style.display = 'none'; // Скрываем "сейчас скажу"
                    let dirText = '';
                    if (selectedDir === 'buy') {
                        dirText = TRANSLATIONS[userLang]['signal_buy'];
                        signalDirection.className = 'signal-step buy-signal';
                    } else {
                        dirText = TRANSLATIONS[userLang]['signal_sell'];
                        signalDirection.className = 'signal-step sell-signal';
                    }
                    signalDirection.innerHTML = dirText;
                    signalDirection.style.display = 'block';
                    
                    // --- Этап 5: Появление результата через время экспирации ---
                    let expirationInMs = 0;
                    const timeValue = parseInt(selectedExp.substring(1));
                    if (selectedExp.startsWith('M')) {
                        expirationInMs = timeValue * 60 * 1000;
                    } else if (selectedExp.startsWith('S')) {
                        expirationInMs = timeValue * 1000;
                    }

                    setTimeout(() => {
                        signalResult.innerHTML = TRANSLATIONS[userLang]['signal_win'];
                        signalResult.style.display = 'block';
                        document.getElementById('signal-back-container').style.display = 'block';
                    }, expirationInMs);

                }, 6000);

            }, 7000);
        };
    }


    function setupNavigation() {
        // Onboarding
        document.getElementById('btn-onb1-next').onclick = () => showView('onboarding-2-view');
        document.getElementById('btn-onb2-back').onclick = () => showView('onboarding-1-view');
        document.getElementById('btn-onb2-next').onclick = () => showView('onboarding-3-view');
        document.getElementById('btn-onb3-back').onclick = () => showView('onboarding-2-view');
        document.getElementById('btn-onb3-next').onclick = () => showView('onboarding-4-view');
        document.getElementById('btn-onb4-back').onclick = () => showView('onboarding-3-view');
        // Signals
        document.getElementById('btn-vip-signal').onclick = () => showView('wip-view');
        document.getElementById('btn-simple-signal').onclick = startSignalFlow; // <--- ИЗМЕНЕНО
        document.getElementById('btn-wip-back').onclick = () => showView('post-deposit-view');
        document.getElementById('btn-signal-back').onclick = () => showView('post-deposit-view'); // <--- НОВОЕ
    }
    
    async function main() {
        if (!tg.initDataUnsafe || !tg.initDataUnsafe.user) {
            applyTranslations('en'); // Default lang if no user
            showView('error-view');
            return;
        }

        const user = tg.initDataUnsafe.user;
        const userId = user.id;
        userLang = (user.language_code && user.language_code.startsWith('ru')) ? 'ru' : 'en'; // <--- Глобальная переменная
        document.documentElement.lang = userLang;
        
        // Apply translations first
        applyTranslations(userLang);
        setupNavigation();
        
        // Setup Register button
        document.getElementById('btn-register').onclick = () => {
            const personalLink = `${REGISTER_LINK_TEMPLATE}&sub_id1=${userId}`;
            tg.openLink(personalLink);
        };

        try {
            const response = await fetch(`/user/${userId}/data`);
            if (!response.ok) throw new Error('Network response was not ok');
            const data = await response.json();
            
            const hasDeposit = data.events.some(e => e[0] === 'FTD' || e[0] === 'dep');

            if (data.is_registered) {
                if (hasDeposit) {
                    const depositEvent = data.events.find(e => e[0] === 'FTD' || e[0] === 'dep');
                    const depositAmount = parseFloat(depositEvent[1]);
                    const profitAmount = (depositAmount * 3.3).toFixed(2);
                    
                    applyTranslations(userLang, {
                        deposit_sum: `$${depositAmount}`,
                        profit_sum: `$${profitAmount}`
                    });
                    showView('post-deposit-view');
                } else {
                    showView('post-reg-view');
                }
            } else {
                showView('onboarding-1-view');
            }
        } catch (error) {
            console.error("Data loading error:", error);
            showView('error-view');
        }
    }

    document.addEventListener('DOMContentLoaded', main);
</script>

</body>
</html>
