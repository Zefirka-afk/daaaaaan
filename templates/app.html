<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --tg-bg: var(--tg-theme-bg-color, #ffffff);
            --tg-text: var(--tg-theme-text-color, #000000);
            --tg-hint: var(--tg-theme-hint-color, #999999);
            --tg-link: var(--tg-theme-link-color, #007aff);
            --tg-button: var(--tg-theme-button-color, #007aff);
            --tg-button-text: var(--tg-theme-button-text-color, #ffffff);
            --tg-secondary-bg: var(--tg-theme-secondary-bg-color, #f0f0f0);
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 20px;
            color: var(--tg-text);
            background-color: var(--tg-bg);
            -webkit-font-smoothing: antialiased;
            text-rendering: optimizeLegibility;
        }
        .view {
            display: none; /* –í—Å–µ —Å–µ–∫—Ü–∏–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–∫—Ä—ã—Ç—ã */
        }
        .view.active {
            display: block; /* –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—É—é */
        }
        /* –°—Ç–∏–ª–∏ –¥–ª—è —ç–∫—Ä–∞–Ω–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ */
        #registration-view {
            text-align: center;
            padding-top: 40px;
        }
        #registration-view h1 {
            font-size: 24px;
            margin-bottom: 15px;
        }
        #registration-view p {
            font-size: 16px;
            color: var(--tg-hint);
            margin-bottom: 30px;
            line-height: 1.5;
        }
        .register-button {
            display: inline-block;
            width: 80%;
            padding: 15px 20px;
            font-size: 18px;
            font-weight: bold;
            color: var(--tg-button-text);
            background-color: var(--tg-button);
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: transform 0.1s ease;
        }
        .register-button:active {
            transform: scale(0.98);
        }
        /* –°—Ç–∏–ª–∏ –¥–ª—è –ª–∏—á–Ω–æ–≥–æ –∫–∞–±–∏–Ω–µ—Ç–∞ (–∏–∑ –ø—Ä–æ—à–ª–æ–π –≤–µ—Ä—Å–∏–∏) */
        #cabinet-view h1 {
            font-size: 24px;
            margin-bottom: 20px;
        }
        #events-list {
            list-style: none; padding: 0;
        }
        .event-card {
            background-color: var(--tg-secondary-bg);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .event-card p { margin: 0 0 5px; }
        .event-card .event-name { font-weight: bold; font-size: 1.1em; color: var(--tg-link); }
        .event-card .event-date { font-size: 0.8em; color: var(--tg-hint); text-align: right; }
        #loader { 
            text-align: center; 
            padding: 40px 20px; 
            font-size: 1.2em; 
            color: var(--tg-hint);
        }
    </style>
</head>
<body>

    <!-- –°–µ–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ -->
    <div id="loader" class="view active">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>

    <!-- –°–µ–∫—Ü–∏—è –¥–ª—è –ù–ï–∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
    <div id="registration-view" class="view">
        <h1>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</h1>
        <p>–î–ª—è –Ω–∞—á–∞–ª–∞ —Ç–æ—Ä–≥–æ–≤–ª–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ<br>—Å–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç —É –Ω–∞—à–µ–≥–æ –ø–∞—Ä—Ç–Ω–µ—Ä–∞.</p>
        <button id="register-btn" class="register-button">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
    </div>

    <!-- –°–µ–∫—Ü–∏—è –¥–ª—è –ó–ê–†–ï–ì–ò–°–¢–†–ò–†–û–í–ê–ù–ù–´–• –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
    <div id="cabinet-view" class="view">
        <h1>–ò—Å—Ç–æ—Ä–∏—è —Å–æ–±—ã—Ç–∏–π</h1>
        <ul id="events-list"></ul>
    </div>

<script>
    const tg = window.Telegram.WebApp;
    // –°—Ä–∞–∑—É –≥–æ–≤–æ—Ä–∏–º Telegram, —á—Ç–æ –≥–æ—Ç–æ–≤—ã –∫ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—é –∏ —Ä–∞—Å—Ç—è–≥–∏–≤–∞–µ–º—Å—è
    tg.ready();
    tg.expand();

    const REGISTER_LINK_TEMPLATE = "https://u3.shortink.io/register?utm_campaign=825192&utm_source=affiliate&utm_medium=sr&a=PDSrNY9vG5LpeF&ac=1d&code=50START";
    
    // –≠–ª–µ–º–µ–Ω—Ç—ã –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
    const loaderView = document.getElementById('loader');
    const registrationView = document.getElementById('registration-view');
    const cabinetView = document.getElementById('cabinet-view');
    const registerBtn = document.getElementById('register-btn');
    const eventsList = document.getElementById('events-list');

    function showView(viewElement) {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        viewElement.classList.add('active');
    }

    function renderEvents(events) {
        if (!events || events.length === 0) {
            eventsList.innerHTML = '<li><p>–°–æ–±—ã—Ç–∏–π –ø–æ–∫–∞ –Ω–µ—Ç.</p></li>';
            return;
        }
        eventsList.innerHTML = ''; // –û—á–∏—â–∞–µ–º —Å–ø–∏—Å–æ–∫
        // [event, sumdep, wdr_sum, status, created_at]
        events.forEach(eventData => {
            const li = document.createElement('li');
            li.className = 'event-card';

            const [eventName, sumDep, sumWdr, status, createdAt] = eventData;
            const formattedDate = new Date(createdAt).toLocaleString('ru-RU', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
            
            let details = '';
            if (eventName === 'reg') {
                details = '<p class="event-name">‚úÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</p><p>–í–∞—à –∞–∫–∫–∞—É–Ω—Ç —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω.</p>';
            } else if (eventName === 'FTD') {
                details = `<p class="event-name">üí∞ –ü–µ—Ä–≤—ã–π –¥–µ–ø–æ–∑–∏—Ç</p><p>–°—É–º–º–∞: <b>$${sumDep}</b></p>`;
            } else if (eventName === 'dep') {
                details = `<p class="event-name">‚ûï –ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ</p><p>–°—É–º–º–∞: <b>$${sumDep}</b></p>`;
            } else if (eventName === 'wdr') {
                details = `<p class="event-name">üíµ –í—ã–≤–æ–¥ —Å—Ä–µ–¥—Å—Ç–≤</p><p>–°—É–º–º–∞: <b>$${sumWdr}</b></p>`;
            } else {
                details = `<p class="event-name">üì¢ –°–æ–±—ã—Ç–∏–µ: ${eventName}</p>`;
            }
            
            if (status) {
                 details += `<p>–°—Ç–∞—Ç—É—Å: <b>${status}</b></p>`;
            }

            li.innerHTML = `${details}<p class="event-date">${formattedDate}</p>`;
            eventsList.appendChild(li);
        });
    }

    // –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö
    function loadUserData(userId) {
        fetch(`/user/${userId}/data`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.is_registered) {
                    renderEvents(data.events);
                    showView(cabinetView);
                } else {
                    showView(registrationView);
                }
            })
            .catch(error => {
                console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:", error);
                loaderView.innerText = "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.";
            });
    }

    // –°–æ–±—ã—Ç–∏–µ: —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞
    document.addEventListener('DOMContentLoaded', function() {
        if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
            const userId = tg.initDataUnsafe.user.id;
            
            // –ù–∞–∑–Ω–∞—á–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞ –∫–Ω–æ–ø–∫—É —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
            registerBtn.onclick = function() {
                const personalLink = `${REGISTER_LINK_TEMPLATE}&sub_id1=${userId}`;
                // –û—Ç–∫—Ä—ã–≤–∞–µ–º –≤–Ω–µ—à–Ω—é—é —Å—Å—ã–ª–∫—É —á–µ—Ä–µ–∑ –º–µ—Ç–æ–¥ Telegram
                tg.openLink(personalLink);
            };

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            loadUserData(userId);
        } else {
            // –≠—Ç–∞ –≤–µ—Ç–∫–∞ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç, –µ—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç—å HTML –Ω–µ —á–µ—Ä–µ–∑ Telegram
            loaderView.innerText = "–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –±–æ—Ç–∞ –≤ Telegram.";
        }
    });
</script>
</body>
</html>
